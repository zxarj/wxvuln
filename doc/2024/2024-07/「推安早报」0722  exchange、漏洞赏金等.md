#  ã€Œæ¨å®‰æ—©æŠ¥ã€0722 | exchangeã€æ¼æ´èµé‡‘ç­‰   
bggsec  ç”²æ–¹å®‰å…¨å»ºè®¾   2024-07-22 09:09  
  

	#  2024-07-22Â ã€Œçº¢è“çƒ­ç‚¹ã€æ¯å¤©å¿«äººä¸€æ­¥  

	>   
>   
> 
			1. æ¨é€ã€Œæ–°ã€çƒ­ã€èµã€ï¼Œå¸®éƒ¨åˆ†äººé˜…è¯»ææ•ˆ
			2. å­¦æœ‰ç²¾è¯»æµ…è¯»æ·±è¯»ï¼Œè‰ºæœ‰ä¼šç†Ÿç²¾ç»åŒ–ï¼Œè§‰çŸ¥æ­¤äº‹é‡èº¬è¡Œã€‚æ¨é€åªåœ¨æµ…è¯»é¢„è§ˆ
			3. æœºè¯»ä¸ºä¸»ï¼Œäººå·¥è¾…åŠ©ï¼Œæ¯æ—¥æ•°ä¸‡ç½‘ç«™ï¼Œ10wæ¨ç‰¹é€Ÿè¯»
			4. æ¨é€å¯èƒ½å¤§ä¼—æˆ–å°ä¼—ï¼Œä¸ä»£è¡¨æœ¬äººåå¥½æˆ–è®¤å¯
			5. å› æ¸²æŸ“å’Œå¤–é“¾åŸå› ï¼Œå…¬ä¼—å·ç”²æ–¹å®‰å…¨å»ºè®¾å‘é€æ—¥æŠ¥æˆ–æ—¥æœŸ,å¦‚20240722è·å–å›¾æ–‡è¯„è®ºç‰ˆpdf
		  
>   
  

	###  0x01 åˆ©ç”¨è§†å›¾çŠ¶æ€æ¼æ´æ”»å‡»å¾®è½¯ExchangeæœåŠ¡å™¨  

	>   
> ç½‘é¡µä¸»è¦ä»‹ç»äº†ASP.NETä¸­çš„View Stateæœºåˆ¶ï¼Œä»¥åŠå¦‚ä½•åˆ©ç”¨View Stateè¿›è¡Œæ”»å‡»ï¼ŒåŒ…æ‹¬åœ¨ç®€å•çš„Webåº”ç”¨ç¨‹åºå’Œå…¨é¢è¡¥ä¸çš„Microsoft Exchange 2019ä¸»æœºä¸Šçš„æ”»å‡»æ‰‹æ®µã€‚æ­¤å¤–ï¼Œè¿˜è®¨è®ºäº†æˆåŠŸæ”»å‡»åäº§ç”Ÿçš„è¯æ®ã€å¦‚ä½•æ£€æµ‹è¿™äº›æ”»å‡»ï¼Œä»¥åŠå¦‚ä½•ä¿®å¤å—å½±å“çš„ç½‘ç»œã€‚
		  
>   
  
  

	  

	
	![](https://mmbiz.qpic.cn/sz_mmbiz_png/icqm3vRUymZnI0TyTWFxr5ibibd88XNQwbicXNOXTITykZaXXPib9ktIonK05mymoJZzvTOniam2B1fs5icXdlbGgzQuQ/640?from=appmsg "")  

	
	![](https://mmbiz.qpic.cn/sz_mmbiz_png/icqm3vRUymZnI0TyTWFxr5ibibd88XNQwbicJfSGiaib2iceXjZzawGGt0c2AVOmuaJf6EQ1oMSTdFqYXD7dxwOQicAia5Q/640?from=appmsg "")  

	
	![](https://mmbiz.qpic.cn/sz_mmbiz_png/icqm3vRUymZnI0TyTWFxr5ibibd88XNQwbicDkAX1trcBFNuQ9O72MwplKsdHf4EJlsJK1FysiccMx7zdm7BcsYYumQ/640?from=appmsg "")  

	  
  
<<<å·¦å³æ»‘åŠ¨è§æ›´å¤š >>>  

	###  çƒ­è¯„   
- IISæœºå™¨å¯†é’¥å’Œè§†å›¾çŠ¶æ€å®‰å…¨æ¼æ´ï¼šè¯†åˆ«ã€ä¿®å¤åŠé˜²å¾¡  
  
- IIS æ°¸ä¹…æ¼æ´è¢«åˆ©ç”¨ï¼ŒViewState æ”»å‡»æŒç»­æ´»è·ƒ  
  

	  

		
	  

	###  å…³é”®ä¿¡æ¯ç‚¹   
- View Stateæ˜¯ASP.NETåº”ç”¨ç¨‹åºä¸­ç”¨äºç»´æŠ¤çŠ¶æ€çš„å…³é”®æœºåˆ¶ï¼Œä½†å®ƒå¯èƒ½ä¼šè¢«ç”¨äºæ”»å‡»ã€‚  
  
- View Stateçš„å®‰å…¨æ€§ä¾èµ–äºåŠ å¯†å’Œè®¤è¯ï¼Œä½†å¹¶éæ‰€æœ‰åº”ç”¨ç¨‹åºéƒ½å¯ç”¨äº†è¿™äº›å®‰å…¨æªæ–½ã€‚  
  
- æ”»å‡»è€…å¯ä»¥é€šè¿‡è·å–æœ‰æ•ˆçš„æœºå™¨å¯†é’¥å’Œç›¸å…³çš„å®‰å…¨ç®—æ³•æ¥æ„é€ æ¶æ„çš„View Stateï¼Œä»è€Œå®ç°è¿œç¨‹ä»£ç æ‰§è¡Œã€‚  
  
- æ£€æµ‹View Stateæ”»å‡»çš„å…³é”®åœ¨äºåˆ†æWindowsäº‹ä»¶æ—¥å¿—ï¼Œç‰¹åˆ«æ˜¯äº‹ä»¶ID 1316ã€‚  
  

	
	  
ğŸ·ï¸: è§†å›¾çŠ¶æ€, æ¼æ´åˆ©ç”¨, å¾®è½¯Exchange, ç½‘ç»œå®‰å…¨  
###  0x02 Back-Me-Upï¼šè‡ªåŠ¨åŒ–æ¼æ´æŒ–æ˜å·¥å…·  

	>   
> Back-Me-Up æ˜¯ä¸€ä¸ªè‡ªåŠ¨åŒ–æ¼æ´æŒ–æ˜è¿‡ç¨‹çš„å·¥å…·ï¼Œå®ƒé€šè¿‡æ”¶é›†äº’è”ç½‘æ¡£æ¡ˆä¸­çš„URLsï¼Œå¹¶ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼å’Œæ¨¡å¼æ¥æ£€æµ‹æ•æ„Ÿæ•°æ®æ³„éœ²ã€‚
		  
>   
  
  

	  

	
	![](https://mmbiz.qpic.cn/sz_mmbiz_png/icqm3vRUymZnI0TyTWFxr5ibibd88XNQwbicyMD8GdDsNhy9DDXYapeaDepRJoXmUbkbZAKI4zqlicIz7aqQpG2YIHA/640?from=appmsg "")  

	
	![](https://mmbiz.qpic.cn/sz_mmbiz_png/icqm3vRUymZnI0TyTWFxr5ibibd88XNQwbic2qabGFPlMjAf1LNHIZ3aHlGBVKH1xqPlEXkI3d9LJyeHTHibbuTgwyQ/640?from=appmsg "")  

	
	![](https://mmbiz.qpic.cn/sz_mmbiz_png/icqm3vRUymZnI0TyTWFxr5ibibd88XNQwbicS1369pn5BgkVV0dlvykuibLqCPsFn6mb4K7icIib8kmMSGJsad0AlG2zw/640?from=appmsg "")  

	  
  
<<<å·¦å³æ»‘åŠ¨è§æ›´å¤š >>>  

	###  çƒ­è¯„   
- è‡ªåŠ¨åŒ–æ¼æ´èµé‡‘æµç¨‹å·¥å…·  
  

	  

		
	  

	###  å…³é”®ä¿¡æ¯ç‚¹   
- Back-Me-Up æ—¨åœ¨å¸®åŠ©æ¼æ´èµé‡‘è€…å’Œæ¸—é€æµ‹è¯•äººå‘˜è‡ªåŠ¨åŒ–æ•æ„Ÿæ•°æ®æ³„éœ²çš„æ£€æµ‹è¿‡ç¨‹ã€‚  
  
- è¯¥å·¥å…·çš„æ ¸å¿ƒåŠŸèƒ½åŒ…æ‹¬è‡ªåŠ¨åŒ–çš„URLæ”¶é›†ã€æ•æ„Ÿæ‰©å±•åçš„è¿‡æ»¤å’ŒåŸºäºæ­£åˆ™è¡¨è¾¾å¼çš„æ•°æ®åˆ†æã€‚  
  
- Back-Me-Up æä¾›äº†ä¸€ä¸ªç”¨æˆ·å‹å¥½çš„å‘½ä»¤è¡Œç•Œé¢ï¼Œå¹¶ä¸”å…·æœ‰çµæ´»æ€§ï¼Œå¯ä»¥æ ¹æ®ç”¨æˆ·çš„éœ€æ±‚æ·»åŠ æ›´å¤šçš„æ‰©å±•åã€‚  
  
- ä½œè€…å¼ºè°ƒäº†è¯¥å·¥å…·çš„åˆæ³•å’Œè´Ÿè´£ä»»ä½¿ç”¨ï¼Œå¹¶å¯¹å…¶ä½¿ç”¨æä¾›äº†æ˜ç¡®çš„æŒ‡å¯¼å’Œé™åˆ¶ã€‚  
  

	
	  
ğŸ·ï¸: æ¼æ´æŒ–æ˜, æ•°æ®æ³„éœ², è‡ªåŠ¨åŒ–å·¥å…·  
###  0x03 æŒ‘æˆ˜é€šè¿‡ï¼šå‡»è´¥Windows Defenderå‡­è¯é˜²æŠ¤  

	>   
> æœ¬æ–‡ä»‹ç»äº†æ–°çš„æŠ€æœ¯æ‰‹æ®µï¼Œç”¨äºåœ¨Windows Defender Credential Guardä¿æŠ¤ä¸‹ä»åŠ å¯†çš„å‡­æ®ä¸­æ¢å¤NTLMå“ˆå¸Œå€¼ã€‚
		  
>   
  



	###  çƒ­è¯„   

	  

		
	  

	###  å…³é”®ä¿¡æ¯ç‚¹   
- Credential Guardè™½ç„¶æä¾›äº†ä¿æŠ¤ï¼Œä½†å¹¶éå®Œå…¨å®‰å…¨ã€‚æ”»å‡»è€…å¯ä»¥é€šè¿‡æ–°çš„æŠ€æœ¯æ‰‹æ®µæ¥ç»•è¿‡å…¶ä¿æŠ¤æœºåˆ¶ã€‚  
  
- æ”»å‡»è€…å¯ä»¥é€šè¿‡ä¸LSAIsoè¿›ç¨‹çš„äº¤äº’æ¥è·å–åŠ å¯†çš„NTLMå“ˆå¸Œå€¼ã€‚é€šè¿‡ALPCï¼ˆAdvanced Local Procedure Callsï¼‰å’ŒRPCï¼ˆRemote Procedure Callsï¼‰ä¸LSAIsoè¿›ç¨‹é€šä¿¡ï¼Œå¯ä»¥æ‰§è¡Œæ“ä½œä»¥è§£å¯†NTLMå“ˆå¸Œå€¼ã€‚  
  
- åŠ å¯†çš„NTLMå‡­æ®å¯ä»¥è·¨é‡å¯æŒä¹…åŒ–ã€‚è¿™æ„å‘³ç€å³ä½¿ç³»ç»Ÿé‡å¯ï¼Œæ”»å‡»è€…ä»ç„¶å¯ä»¥åˆ©ç”¨ä¹‹å‰è·å–çš„ä¿¡æ¯æ¥è¿›è¡Œæ”»å‡»ã€‚  
  
- æ”»å‡»è€…å¯ä»¥åˆ©ç”¨AD CSæ¥è¯·æ±‚è¯ä¹¦ã€‚é€šè¿‡æ¨¡æ‹Ÿç”¨æˆ·çš„è¯ä¹¦è¯·æ±‚ï¼Œæ”»å‡»è€…å¯ä»¥è·å–è¯ä¹¦å¹¶è¿›ä¸€æ­¥åˆ©ç”¨è¯¥è¯ä¹¦æ¥è®¤è¯å¹¶æå–NTLMå“ˆå¸Œå€¼ã€‚  
  

	
	  
ğŸ·ï¸: NTLM, LSASS, LSAIso, å‡­è¯, å“ˆå¸Œ  
###  0x04 æ–°å‹çš„ä¸‰æ˜æ²»æ”»å‡»åº”ç”¨åœºæ™¯  

	>   
> æœ¬æ–‡ä»‹ç»äº†ä¸€ç§æ–°çš„åˆ©ç”¨åœºæ™¯ï¼Œå³åœ¨ä¸çŸ¥é“æ—¶é—´æˆ³çš„æƒ…å†µä¸‹ï¼Œé€šè¿‡ç›‘æ§å’ŒçŒœæµ‹ MongoDB Object ID æ ¼å¼çš„é‚€è¯·ä»¤ç‰Œæ¥å®ç°æ”»å‡»ã€‚
		  
>   
  
  

	  

	
	![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/icqm3vRUymZnI0TyTWFxr5ibibd88XNQwbick962wX1rNJKRWWXK5v3xwMJiaXeGpj79bajCkUFicHZXbnRxaTG5RTSA/640?from=appmsg "")  

	
	![](https://mmbiz.qpic.cn/sz_mmbiz_png/icqm3vRUymZnI0TyTWFxr5ibibd88XNQwbicqw20ksMRGr5Cv8uWc6owlPOEwwUxDQOX79L7ZTFK4phGMdsGF0aSFg/640?from=appmsg "")  

	
	![](https://mmbiz.qpic.cn/sz_mmbiz_png/icqm3vRUymZnI0TyTWFxr5ibibd88XNQwbic9GM74RITAeqSI43FJqe6FM1fuyicyQIYjia3oh0SoeMNujBpiaXwpuzkA/640?from=appmsg "")  

	  
  
<<<å·¦å³æ»‘åŠ¨è§æ›´å¤š >>>  

	###  çƒ­è¯„   
- æ—¶é—´å‹å¯†é’¥æ–°åº”ç”¨ï¼šå®æ—¶ç›‘æ§ Web åº”ç”¨é‚€è¯·  
  

	  

		
	  

	###  å…³é”®ä¿¡æ¯ç‚¹   
- æ—¶é—´æˆ³å’Œè®¡æ•°å™¨çš„é‡è¦æ€§ï¼šMongoDB Object ID ç”±æ—¶é—´æˆ³ã€è¿›ç¨‹å’Œè®¡æ•°å™¨ç»„æˆï¼Œè¿™äº›ä¿¡æ¯å¯¹äºå®æ–½ä¸‰æ˜æ²»æ”»å‡»è‡³å…³é‡è¦ã€‚  
  
- é•¿æ—¶é—´æ®µçš„æ”»å‡»ä¸åˆ‡å®é™…ï¼šé•¿æ—¶é—´æ®µçš„ä¸‰æ˜æ²»æ”»å‡»éœ€è¦é«˜é€ŸéªŒè¯å¤§é‡ä»¤ç‰Œï¼Œè¿™åœ¨ç°å®ä¸­ä¸å¤ªå¯è¡Œã€‚  
  
- çŸ­æ—¶é—´æ®µçš„ä¼˜åŠ¿ï¼šé€šè¿‡ä½¿ç”¨å¤šä¸ªçŸ­æ—¶é—´æ®µï¼Œå¯ä»¥æ˜¾è‘—å‡å°‘éœ€è¦çŒœæµ‹çš„ä»¤ç‰Œæ€»æ•°ï¼Œä»è€Œæé«˜æ”»å‡»çš„å¯è¡Œæ€§ã€‚  
  
- è®¡æ•°å™¨ç›‘æ§çš„ä½œç”¨ï¼šé€šè¿‡ç›‘æ§è®¡æ•°å™¨çš„å˜åŒ–ï¼Œæ”»å‡»è€…å¯ä»¥æ›´æœ‰æ•ˆåœ°æ£€æµ‹æ–°ä»¤ç‰Œçš„ç”Ÿæˆï¼Œå¹¶ä¼˜åŒ–è¯·æ±‚æ•°é‡ã€‚  
  

	
	  
ğŸ·ï¸: æ”»å‡», MongoDB, å®‰å…¨æ¼æ´, æ—¶é—´æˆ³  
###  0x05 Heliosï¼šè‡ªåŠ¨åŒ–XSSå®¡è®¡å·¥å…·  

	>   
> Helios æ˜¯ä¸€ä¸ªè‡ªåŠ¨åŒ–çš„è·¨ç«™è„šæœ¬ï¼ˆXSSï¼‰å®¡è®¡å·¥å…·ï¼Œæ”¯æŒå¤šç§æµè§ˆå™¨ï¼Œèƒ½å¤Ÿå¯¹ URL å‚æ•°ã€POST å‚æ•°ã€å¤´éƒ¨ä¿¡æ¯å’Œ DOM å†…å®¹è¿›è¡Œå…¨é¢æ‰«æï¼Œæ£€æµ‹ XSS æ¼æ´ï¼Œå¹¶æä¾›è¯¦ç»†çš„æŠ¥å‘ŠåŠŸèƒ½ã€‚
		  
>   
  
  

	  

	
	![](https://mmbiz.qpic.cn/sz_mmbiz_png/icqm3vRUymZnI0TyTWFxr5ibibd88XNQwbicg1wrO3UAFX4lO2iaCmiaQ1BgEajicV2WGBbRD9Oia1GicspM6mq4AHYXPGA/640?from=appmsg "")  

	
	![](https://mmbiz.qpic.cn/sz_mmbiz_png/icqm3vRUymZnI0TyTWFxr5ibibd88XNQwbicicWQ5nSshSKgWb8oTB43GhNTuc3xE3EzCxuBICZP9nZXLSryDib93luQ/640?from=appmsg "")  

	
	![](https://mmbiz.qpic.cn/sz_mmbiz_png/icqm3vRUymZnI0TyTWFxr5ibibd88XNQwbictvPqRSH42C9ydafBwvicgv8JMicdVnqZ0eqRl5E69s2u43vwk3XjF6lQ/640?from=appmsg "")  

	  
  
<<<å·¦å³æ»‘åŠ¨è§æ›´å¤š >>>  

	###  çƒ­è¯„   
- Heliosï¼šè‡ªåŠ¨åŒ–è·¨ç«™è„šæœ¬ (XSS) æµ‹è¯•å·¥å…·  
  
- Helios: è‡ªåŠ¨åŒ–è·¨ç«™è„šæœ¬ (XSS) æ¼æ´å®¡è®¡å·¥å…·  
  

	  

		
	  

	###  å…³é”®ä¿¡æ¯ç‚¹   
- Helios æ˜¯ä¸€ä¸ªé’ˆå¯¹ XSS æ¼æ´çš„è‡ªåŠ¨åŒ–å®¡è®¡å·¥å…·ï¼Œå®ƒæä¾›äº†ä¸€ç³»åˆ—é«˜çº§åŠŸèƒ½ï¼Œå¦‚å¤šæµè§ˆå™¨æ”¯æŒã€æ— ç•Œé¢æ¨¡å¼ã€å¤šçº¿ç¨‹å¹¶å‘æ‰«æã€è‡ªå®šä¹‰é…ç½®å’Œçˆ¬è™«åŠŸèƒ½ï¼Œä»¥åŠè¯¦ç»†çš„æŠ¥å‘Šè¾“å‡ºã€‚  
  
- å·¥å…·å¼ºè°ƒå¯¹ DOM-Based XSS æ¼æ´çš„æ£€æµ‹ï¼Œå¹¶é€šè¿‡è‡ªåŠ¨åŒ–çš„ payload å®šåˆ¶æé«˜äº†æ£€æµ‹çš„å‡†ç¡®æ€§ã€‚  
  
- Helios ç›®å‰æ­£åœ¨ç§¯æå¼€å‘ä¸­ï¼Œè™½ç„¶å·²ç»å…·å¤‡äº†å¼ºå¤§çš„æ‰«æèƒ½åŠ›ï¼Œä½†ä»ç„¶å¤„äºæ—©æœŸé˜¶æ®µï¼Œå¯èƒ½å­˜åœ¨ä¸ç¨³å®šæ€§å’Œå±€é™æ€§ã€‚  
  
- å¼€å‘è€…é¼“åŠ±ç¤¾åŒºçš„å‚ä¸å’Œåé¦ˆï¼Œä»¥å¸®åŠ©æ”¹è¿›å·¥å…·ï¼Œå¹¶åœ¨æœªæ¥ç‰ˆæœ¬ä¸­æä¾›æ›´å¤šçš„åŠŸèƒ½å’Œæ€§èƒ½ä¼˜åŒ–ã€‚  
  

	
	  
ğŸ·ï¸: XSS, è‡ªåŠ¨åŒ–å®¡è®¡, ç½‘ç»œå®‰å…¨, æµè§ˆå™¨æ”¯æŒ, å¤šçº¿ç¨‹æ‰«æ  
  
  

	  
![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/icqm3vRUymZlbmEWU7ZApsl3ia3YLicI4H3nwksKq8ZBqrghjtia9TYiblaxU2VXrUpDcAM57Ric0wX9pBg69IusWVyg/640?wx_fmt=jpeg "")  

	  

		å¿«æ¥å’Œè€å¸æœºä»¬ä¸€èµ·å­¦ä¹ å§  
  
